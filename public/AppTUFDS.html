<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>App TUFDS ‚Äì Consulentes</title>

<!-- polyfill para manter google.script.run -->
<script src="/gsrun.js"></script>

<style>
  :root{
    --bg:#f3f4f6;
    --card:#ffffff;
    --text:#111827;
    --muted:#6b7280;
    --border:#e5e7eb;
    --accent:#0f766e;
    --accent-soft:#ecfdf5;
    --shadow:0 1px 3px rgba(0,0,0,.06);
    --radius:16px;
  }

  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans",Arial,"Apple Color Emoji","Segoe UI Emoji";
    background:var(--bg);
    color:var(--text);
  }

  /* ===== shell / columns ===== */
  .shell{
    max-width:1200px;
    margin:0 auto;
    padding:24px 16px 40px;
    display:grid;
    grid-template-columns: 1fr 320px;
    gap:24px;
  }
  @media (max-width: 1024px){
    .shell{ grid-template-columns: 1fr }
  }

  /* ===== header ===== */
  .header{
    grid-column:1 / -1;
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:16px 20px;
    display:flex;
    align-items:center;
    gap:14px;
  }
  .logo-circle{
    width:56px;height:56px;border-radius:50%;
    background:var(--accent-soft);
    border:1px solid #a7f3d0;
    color:var(--accent);
    display:grid;place-items:center;
    font-weight:800;font-size:22px;
    flex:0 0 56px;
  }
  .header h1{
    margin:0;font-size:24px;line-height:1.15;
  }
  .sub{ color:var(--muted); margin-top:2px; font-size:14px }

  /* ===== tabs ===== */
  .tabs{
    grid-column:1 / -1;
    display:flex; flex-wrap:wrap; gap:10px;
    margin-top:12px; margin-bottom:10px;
  }
  .tab-btn{
    border:1px solid var(--border);
    background:#fff;
    color:var(--text);
    padding:10px 16px;
    border-radius:999px;
    font-weight:600;
    font-size:15px;
    cursor:pointer;
  }
  .tab-btn.active{
    background:var(--accent);
    border-color:var(--accent);
    color:#ecfdf5;
  }

  /* ===== cards ===== */
  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:20px;
  }
  h2{ margin:0 0 8px 0; font-size:22px }
  .muted{ color:var(--muted); font-size:14px }

  /* ===== home grid ===== */
  .home-grid{
    margin-top:10px;
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:16px;
  }
  @media (max-width: 720px){
    .home-grid{ grid-template-columns: 1fr }
  }

  .home-card{
    display:flex; align-items:center; gap:14px;
    background:#fff; border:1px solid var(--border);
    padding:18px; border-radius:14px; cursor:pointer;
    transition:transform .08s ease, background .15s ease;
  }
  .home-card:hover{ background:#f9fafb; transform:translateY(-1px) }
  .home-card-icon{
    width:44px;height:44px;border-radius:12px;
    display:grid;place-items:center;font-size:26px;
    background:#eef2ff;
  }
  .home-card strong{ font-size:18px; display:block; margin-bottom:4px }

  /* ===== sections ===== */
  .section{ display:none; }
  .section.active{ display:block; }
  .col-right .card + .card{ margin-top:16px }

  /* ===== calendario list ===== */
  .cal-toolbar{
    display:flex; align-items:center; gap:10px; margin-bottom:10px;
  }
  .cal-select{
    padding:8px 12px; border:1px solid var(--border);
    border-radius:10px; background:#fff; font-size:14px;
  }
  .cal-list{ display:flex; flex-direction:column; gap:12px }
  .cal-item{
    display:flex; gap:12px; align-items:center;
    background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px;
  }
  .cal-date{
    min-width:78px; text-align:center; color:var(--accent);
    background:var(--accent-soft); border-radius:10px; padding:8px 6px; font-weight:700;
  }
  .cal-date .dia{ font-size:22px }
  .cal-title{ font-size:16px; font-weight:700 }

  /* ===== sidebar "Espa√ßo do TUFDS" ===== */
  .side-title{ font-weight:800; font-size:26px; margin:0 0 8px 0 }
  .next-list{ display:flex; flex-direction:column; gap:10px; margin-top:6px }
  .next-item{
    background:#d1fae5; border-radius:14px; padding:10px 12px;
    display:flex; justify-content:space-between; gap:16px; align-items:center;
  }
  .next-date{ font-weight:600 }
  .next-badge{
    background:#10b981; color:#052e1b; font-weight:800;
    padding:6px 12px; border-radius:999px; white-space:nowrap;
  }

  /* ===== modal newsletter ===== */
  .newsletter-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:flex; align-items:center; justify-content:center; z-index:50 }
  .newsletter-backdrop.hidden{ display:none }
  .newsletter-card{ background:#fff; width:min(420px,92%); padding:24px 20px; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.3) }
  .newsletter-card h2{ font-size:20px }
  #newsletter-email{ width:100%; padding:10px 12px; border:1px solid #ccc; border-radius:8px; margin-top:8px }
  .newsletter-actions{ display:flex; justify-content:flex-end; gap:8px; margin-top:12px }
  .btn-primario,.btn-secundario{ border:0; border-radius:999px; padding:8px 16px; font-size:14px; cursor:pointer }
  .btn-primario{ background:var(--accent); color:#fff }
  .btn-secundario{ background:#e5e7eb; color:#111827 }
</style>
</head>
<body>

<div class="shell">

  <!-- HEADER -->
  <div class="header">
    <div class="logo-circle">T</div>
    <div>
      <h1>Terreiro de Umbanda Filhos do Sagrado - TUFDS</h1>
      <div class="sub">Espa√ßo de f√©, acolhimento e aprendizado.</div>
    </div>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="home">In√≠cio</button>
    <button class="tab-btn" data-tab="calendario">Calend√°rio</button>
    <button class="tab-btn" data-tab="pontos">Pontos Cantados</button>
    <button class="tab-btn" data-tab="playlists">Playlists</button>
    <button class="tab-btn" data-tab="pedidos">Pedidos</button>
    <button class="tab-btn" data-tab="doacoes">Doa√ß√µes</button>
    <button class="tab-btn" data-tab="biblioteca">Biblioteca</button>
    <button class="tab-btn" data-tab="sobre">Sobre a Casa</button>
    <button class="tab-btn" data-tab="orixas">Orix√°s</button>
    <button class="tab-btn" data-tab="faq">Perguntas Frequentes</button>
    <button class="tab-btn" data-tab="contato">Contato</button>
  </div>

  <!-- COLUNA ESQUERDA -->
  <div>

    <!-- HOME -->
    <div id="sec-home" class="section active">
      <h1 style="margin:6px 0 6px;font-size:44px;line-height:1.1">Novo na Umbanda? Comece por aqui.</h1>

      <div class="home-grid">
        <div class="home-card" id="card-primeiros">
          <div class="home-card-icon">üë£</div>
          <div>
            <strong>Primeiros passos</strong>
            <span class="muted">Orienta√ß√µes b√°sicas para sua primeira gira.</span>
          </div>
        </div>

        <div class="home-card" id="card-visitantes">
          <div class="home-card-icon">‚úÖ</div>
          <div>
            <strong>Orienta√ß√µes para visitantes</strong>
            <span class="muted">Como se portar e como pedir ajuda espiritual.</span>
          </div>
        </div>

        <div class="home-card" id="card-biblioteca">
          <div class="home-card-icon">üìö</div>
          <div>
            <strong>Biblioteca</strong>
            <span class="muted">Acesse apostilas, PDFs e materiais da casa.</span>
          </div>
        </div>

        <div class="home-card" id="card-historia">
          <div class="home-card-icon">üìñ</div>
          <div>
            <strong>Hist√≥ria da Umbanda</strong>
            <span class="muted">Origem, princ√≠pios e fundamentos.</span>
          </div>
        </div>

        <div class="home-card" id="card-hierarquia">
          <div class="home-card-icon">üßë‚Äçü§ù‚Äçüßë</div>
          <div>
            <strong>Hierarquia da Casa</strong>
            <span class="muted">Quem √© quem no TUFDS.</span>
          </div>
        </div>

        <div class="home-card" id="card-orixas">
          <div class="home-card-icon">‚ö°</div>
          <div>
            <strong>Orix√°s na Umbanda</strong>
            <span class="muted">For√ßas, linhas e fundamentos.</span>
          </div>
        </div>

        <div class="home-card" id="card-ritual">
          <div class="home-card-icon">üïØ</div>
          <div>
            <strong>Ritual da gira</strong>
            <span class="muted">Passo a passo da gira.</span>
          </div>
        </div>

        <div class="home-card" id="card-doacoes">
          <div class="home-card-icon">üíö</div>
          <div>
            <strong>Doa√ß√µes para a Casa</strong>
            <span class="muted">Veja o que o terreiro precisa e escolha como ajudar.</span>
          </div>
        </div>

        <div class="home-card" id="card-pedidos">
          <div class="home-card-icon">üåπ</div>
          <div>
            <strong>Pedidos de Rosas & Itens</strong>
            <span class="muted">Reserve rosas, velas e outros itens para a gira.</span>
          </div>
        </div>
      </div>
    </div>

    <!-- PEDIDOS -->
    <div id="sec-pedidos" class="section">
      <div class="card">
        <h2>Pedidos para Giras</h2>
        <div data-include="/partials/Pedidos.html"></div>
      </div>
    </div>

    <!-- CALEND√ÅRIO -->
    <div id="sec-calendario" class="section">
      <div class="card">
        <h2>Calend√°rio de Giras</h2>
        <p class="muted">Datas puxadas automaticamente da aba Calend√°rio.</p>

        <div class="cal-toolbar">
          <label>Filtrar por m√™s:</label>
          <select id="calMesSelect" class="cal-select"><option value="">Todos</option></select>
        </div>
        <div id="calLista" class="cal-list"></div>
      </div>
    </div>

    <!-- DOA√á√ïES -->
    <div id="sec-doacoes" class="section">
      <div class="card">
        <h2>Doa√ß√µes</h2>
        <div data-include="/partials/Doacoes.html"></div>
      </div>
    </div>

    <!-- BIBLIOTECA -->
    <div id="sec-biblioteca" class="section">
      <div class="card">
        <h2>Biblioteca</h2>
        <div data-include="/partials/Biblioteca.html"></div>
      </div>
    </div>

    <!-- SOBRE -->
    <div id="sec-sobre" class="section">
      <div class="card" style="margin-bottom:12px">
        <div class="sobre-tabs">
          <button class="tab-btn sobre-tab-btn active" data-sobre="info">Sobre o TUFDS</button>
          <button class="tab-btn sobre-tab-btn" data-sobre="historia">Hist√≥ria da Umbanda</button>
          <button class="tab-btn sobre-tab-btn" data-sobre="visitantes">Orienta√ß√µes para Visitantes</button>
          <button class="tab-btn sobre-tab-btn" data-sobre="primeiros">Primeiros Passos</button>
          <button class="tab-btn sobre-tab-btn" data-sobre="hierarquia">Hierarquia da Casa</button>
          <button class="tab-btn sobre-tab-btn" data-sobre="ritual">Ritual da Gira</button>
        </div>
      </div>

      <div id="sobre-info" class="sobre-panel card active" data-include="/partials/SobreTUFDS.html"></div>
      <div id="sobre-historia" class="sobre-panel card" data-include="/partials/HistUmbanda.html"></div>
      <div id="sobre-visitantes" class="sobre-panel card" data-include="/partials/Visitantes.html"></div>
      <div id="sobre-primeiros" class="sobre-panel card" data-include="/partials/PrimeirosPassos.html"></div>
      <div id="sobre-hierarquia" class="sobre-panel card" data-include="/partials/Hierarquia.html"></div>
      <div id="sobre-ritual" class="sobre-panel card" data-include="/partials/RitualTUFDS.html"></div>
    </div>

    <!-- ORIX√ÅS -->
    <div id="sec-orixas" class="section">
      <div class="card" data-include="/partials/Orixas.html"></div>
    </div>

    <!-- PONTOS / PLAYLISTS / FAQ / CONTATO -->
    <div id="sec-pontos" class="section">
      <div class="card" data-include="/partials/Pontos.html"></div>
    </div>

    <div id="sec-playlists" class="section">
      <div class="card"><h2>Playlists</h2></div>
    </div>

    <div id="sec-faq" class="section">
      <div class="card"><h2>Perguntas Frequentes</h2></div>
    </div>

    <div id="sec-contato" class="section">
      <div class="card" data-include="/partials/Contato.html"></div>
    </div>

  </div>

  <!-- COLUNA DIREITA -->
  <aside class="col-right">
    <div class="card">
      <h2 class="side-title">Espa√ßo do TUFDS</h2>
      <p class="muted">Terreiro de Umbanda Filhos do Sagrado ‚Äì Manaus/AM</p>
      <h3 style="margin:10px 0 8px">Pr√≥ximas giras</h3>
      <div id="homeProximasLista" class="next-list"></div>
    </div>
  </aside>

</div>

<!-- MODAL NEWSLETTER -->
<div id="newsletter-modal" class="newsletter-backdrop hidden">
  <div class="newsletter-card">
    <h2>Quer receber nossos avisos?</h2>
    <p>Deixe seu e-mail para receber comunicados do terreiro.</p>
    <input type="email" id="newsletter-email" placeholder="seuemail@exemplo.com" />
    <div class="newsletter-actions">
      <button type="button" onclick="fecharNewsletterModal()" class="btn-secundario">Agora n√£o</button>
      <button type="button" onclick="enviarNewsletterEmail()" class="btn-primario">Quero receber</button>
    </div>
  </div>
</div>

<script>
<script>
/* ===== includes (partials) ===== */
async function loadPartial(el) {
  const url = el.getAttribute('data-include');
  try {
    const html = await (await fetch(url)).text();

    // injeta o HTML
    el.innerHTML = html;

    // executa <script> internos do partial
    const scripts = el.querySelectorAll('script');
    scripts.forEach(old => {
      const s = document.createElement('script');
      // preserva type, src e texto
      if (old.type) s.type = old.type;
      if (old.src) {
        s.src = old.src;
      } else {
        s.text = old.textContent || '';
      }
      // garante execu√ß√£o ap√≥s inserir
      old.parentNode.replaceChild(s, old);
    });
  } catch (e) {
    console.error('Erro ao carregar partial', url, e);
    el.innerHTML = '<p class="muted">Conte√∫do indispon√≠vel.</p>';
  }
}

// carrega todos os partials e executa scripts contidos
document.querySelectorAll('[data-include]').forEach(loadPartial);
</script>


/* ===== abas ===== */
const tabs = document.querySelectorAll('.tab-btn:not(.sobre-tab-btn)');
const sections = document.querySelectorAll('.section');

tabs.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    tabs.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');

    const tab = btn.dataset.tab;
    sections.forEach(sec=>sec.classList.toggle('active', sec.id===`sec-${tab}`));

    // se abriu a aba Calend√°rio, garante a carga
    if (tab === 'calendario') {
      garanteCalendario();
    }
  });
});

/* ===== sub-abas (Sobre) ===== */
const sobreBtns   = document.querySelectorAll('.sobre-tab-btn');
const sobrePanels = document.querySelectorAll('.sobre-panel');
sobreBtns.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    sobreBtns.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const key = btn.dataset.sobre;
    sobrePanels.forEach(p=>p.classList.toggle('active', p.id===`sobre-${key}`));
  });
});

/* ===== atalhos cards ===== */
document.getElementById('card-doacoes')?.addEventListener('click', ()=>document.querySelector('.tab-btn[data-tab="doacoes"]').click());
document.getElementById('card-biblioteca')?.addEventListener('click', ()=>document.querySelector('.tab-btn[data-tab="biblioteca"]').click());
document.getElementById('card-pedidos')?.addEventListener('click', ()=>document.querySelector('.tab-btn[data-tab="pedidos"]').click());

/* ===== calend√°rio ===== */
let eventosCalendario = [];
let calJaBuscou = false;

const calSelect     = document.getElementById('calMesSelect');
const calLista      = document.getElementById('calLista');
const homeProxLista = document.getElementById('homeProximasLista');

function setLoadingCalendario(on=true){
  if(!calLista) return;
  calLista.innerHTML = on
    ? '<div class="muted">Carregando calend√°rio...</div>'
    : '';
}

function garanteCalendario(){
  if (!calJaBuscou || !eventosCalendario.length) {
    carregarCalendario();
  } else {
    montarFiltroMeses();
    renderCalendario();
  }
}

/* ===== nova fun√ß√£o que busca dados da API ===== */
async function carregarCalendario(){
  try {
    setLoadingCalendario(true);
    const res = await fetch('/api/getCalendarioEventos');
    const data = await res.json();

    calJaBuscou = true;
    eventosCalendario = data.eventos || [];
    montarFiltroMeses();
    renderCalendario();
    renderHomeProximas();
    setLoadingCalendario(false);

  } catch (err) {
    console.error('Erro ao carregar calend√°rio:', err);
    calLista.innerHTML = `<div class="muted">
      Falha ao carregar a agenda. ${err?.message ? 'Detalhe: '+err.message : ''}
    </div>`;
  }
}

/* ===== renderiza√ß√£o do calend√°rio ===== */
function montarFiltroMeses(){
  if(!calSelect) return;
  calSelect.innerHTML = '<option value="">Todos</option>';
  const nomes=['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
  const mapa={};
  eventosCalendario.forEach(ev=>{
    if(ev.mesAnoKey && !mapa[ev.mesAnoKey]){
      const [ano,mes]=ev.mesAnoKey.split('-');
      mapa[ev.mesAnoKey] = `${nomes[parseInt(mes,10)-1]}/${ano}`;
    }
  });
  Object.keys(mapa).sort().forEach(k=>{
    const o=document.createElement('option'); o.value=k; o.textContent=mapa[k];
    calSelect.appendChild(o);
  });
}

function renderCalendario(){
  if(!calLista) return;
  calLista.innerHTML='';
  let lista = eventosCalendario || [];
  if(calSelect?.value) lista = lista.filter(ev=>ev.mesAnoKey===calSelect.value);

  if(!lista.length){
    calLista.innerHTML='<div class="muted">Nenhuma gira neste m√™s.</div>';
    return;
  }

  lista.forEach(ev=>{
    let nome = ev.linha || ev.atividade || '';
    if(nome.toLowerCase().startsWith('atividade ')) nome = nome.substring(10);
    const [dia,mes,ano] = (ev.dataStr||'').split('/');
    const row=document.createElement('div');
    row.className='cal-item';
    row.innerHTML = `
      <div class="cal-date">
        <div class="dia">${dia||'--'}</div>
        <div>${mes||'--'}/${ano||'--'}</div>
      </div>
      <div class="cal-main">
        <div class="cal-title">Gira ${nome||''}</div>
      </div>`;
    calLista.appendChild(row);
  });
}

calSelect?.addEventListener('change', renderCalendario);

/* ===== pr√≥ximas giras (sidebar) ===== */
function renderHomeProximas(){
  if(!homeProxLista) return;
  homeProxLista.innerHTML='';
  if(!eventosCalendario.length){
    homeProxLista.innerHTML='<p class="muted">Sem giras cadastradas.</p>';
    return;
  }
  const hojeISO = new Date().toISOString().slice(0,10);
  const proximas = eventosCalendario.filter(ev=>ev.iso >= hojeISO).slice(0,4);
  proximas.forEach(ev=>{
    let nome = ev.linha || ev.atividade || '';
    if(nome.toLowerCase().startsWith('atividade ')) nome = nome.substring(10);
    const item = document.createElement('div');
    item.className = 'next-item';
    item.innerHTML = `<span class="next-date">${ev.dataStr}</span>
                      <span class="next-badge">Gira ${nome}</span>`;
    homeProxLista.appendChild(item);
  });
}

/* ===== newsletter ===== */
function abrirNewsletterModal(){ document.getElementById('newsletter-modal')?.classList.remove('hidden'); }
function fecharNewsletterModal(){ document.getElementById('newsletter-modal')?.classList.add('hidden'); localStorage.setItem('tufds_newsletter_shown','1'); }
function enviarNewsletterEmail(){
  alert('Fun√ß√£o de newsletter desativada neste ambiente.');
}

/* ===== boot ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  garanteCalendario();

  const jaMostrou = localStorage.getItem('tufds_newsletter_shown');
  if(!jaMostrou) abrirNewsletterModal();
});
</script>

</body>
</html>
