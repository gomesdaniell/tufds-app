<section>
  <p class="muted">
    Escolha abaixo itens para doar. Os valores s칚o sugest칫es para apoio 맙 atividades da Casa.
  </p>

  <div class="doa-toolbar">
    <input id="doa-busca" type="text" placeholder="Buscar item..." />
    <select id="doa-tipo">
      <option value="all">Todas as categorias</option>
    </select>
    <button id="doa-filtrar">Buscar</button>
    <button id="doa-reset">Limpar</button>
  </div>

  <div id="doa-catalogo" class="doa-grid">
    <div class="muted">Carregando cat치logo...</div>
  </div>
</section>

<style>
  .doa-toolbar{ display:flex; gap:8px; flex-wrap:wrap; margin:10px 0 14px }
  .doa-toolbar input, .doa-toolbar select, .doa-toolbar button{
    padding:8px 10px; border:1px solid #e5e7eb; border-radius:8px; background:#fff
  }
  .doa-toolbar button{ cursor:pointer }

  .doa-grid{ display:grid; grid-template-columns: repeat(auto-fill,minmax(260px,1fr)); gap:12px }
  .doa-card{
    background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px; display:flex; gap:10px
  }
  .doa-ico{ font-size:24px }
  .doa-main{ flex:1 }
  .doa-title{ font-weight:700 }
  .doa-meta{ color:#6b7280; font-size:12px; margin-top:2px }
</style>

<script>
  let DOA_BRUTO = [];   // cat치logo bruto vindo da API
  let DOA_FILTRO = { texto:'', cat:'all' };

  (function initDoacoes(){
    bindDoaEvents();
    carregarDoaCatalogo();
  })();

  function bindDoaEvents(){
    const busca   = document.getElementById('doa-busca');
    const tipoSel = document.getElementById('doa-tipo');
    const btnFil  = document.getElementById('doa-filtrar');
    const btnRes  = document.getElementById('doa-reset');

    if (btnFil && !btnFil._b){
      btnFil.addEventListener('click', ()=>{
        DOA_FILTRO.texto = (busca.value||'').trim();
        DOA_FILTRO.cat   = (tipoSel.value||'all');
        renderDoaCatalogo(filtraDoa(DOA_FILTRO.texto, DOA_FILTRO.cat));
      });
      btnFil._b = true;
    }
    if (btnRes && !btnRes._b){
      btnRes.addEventListener('click', ()=>{
        busca.value=''; tipoSel.value='all';
        DOA_FILTRO = { texto:'', cat:'all' };
        renderDoaCatalogo(DOA_BRUTO);
      });
      btnRes._b = true;
    }
    if (busca && !busca._b){
      busca.addEventListener('keydown', e=>{
        if(e.key==='Enter'){
          DOA_FILTRO.texto = (busca.value||'').trim();
          renderDoaCatalogo(filtraDoa(DOA_FILTRO.texto, tipoSel.value||'all'));
        }
      });
      busca._b = true;
    }
  }

  async function carregarDoaCatalogo(){
    const box = document.getElementById('doa-catalogo');
    box.innerHTML = '<div class="muted">Carregando cat치logo...</div>';
    try{
      const res = await fetch('/api/getCatalogoDoacoes', { cache:'no-store' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();

      const arr = Array.isArray(data) ? data
                : Array.isArray(data?.catalogo) ? data.catalogo
                : Array.isArray(data?.data?.catalogo) ? data.data.catalogo
                : [];

      DOA_BRUTO = arr.map(x=>({
        idItem   : String(x.idItem ?? x.id ?? '').trim() || String(Math.random()).slice(2),
        categoria: String(x.categoria ?? '').trim(),
        descricao: String(x.descricao ?? x.item ?? '').trim(),
        unidade  : String(x.unidade ?? x.unid ?? '').trim(),
        valor    : Number(x.preco ?? x.pre칞o ?? x.valor ?? 0) || 0
      }))
      .filter(x=> x.descricao)
      .sort((a,b)=>{
        const c = (a.categoria||'').localeCompare(b.categoria||'', 'pt-BR');
        return c !== 0 ? c : a.descricao.localeCompare(b.descricao,'pt-BR');
      });

      montarFiltroCategorias(DOA_BRUTO);
      renderDoaCatalogo(DOA_BRUTO);
    }catch(err){
      console.error(err);
      box.innerHTML = '<div class="muted">Erro ao carregar cat치logo.</div>';
    }
  }

  function montarFiltroCategorias(lista){
    const sel = document.getElementById('doa-tipo');
    const set = new Set();
    lista.forEach(x=>{ if(x.categoria) set.add(x.categoria); });
    // limpa e remonta
    sel.innerHTML = '<option value="all">Todas as categorias</option>';
    [...set].sort((a,b)=>a.localeCompare(b,'pt-BR')).forEach(cat=>{
      const o = document.createElement('option');
      o.value = cat; o.textContent = cat;
      sel.appendChild(o);
    });
  }

  function filtraDoa(texto, categoria){
    const t = String(texto||'').toLowerCase().trim();
    const c = String(categoria||'all');
    return DOA_BRUTO.filter(it=>{
      const passTxt = !t || (it.descricao||'').toLowerCase().includes(t) || (it.categoria||'').toLowerCase().includes(t);
      const passCat = c==='all' || it.categoria===c;
      return passTxt && passCat;
    });
  }

  function renderDoaCatalogo(lista){
    const box = document.getElementById('doa-catalogo');
    if(!lista || !lista.length){
      box.innerHTML = '<div class="muted">Nenhum item encontrado.</div>';
      return;
    }
    let html = '';
    lista.forEach(it=>{
      html += `
        <div class="doa-card">
          <div class="doa-ico">游꾸</div>
          <div class="doa-main">
            <div class="doa-title">${escapeHtml(it.descricao)}</div>
            <div class="doa-meta">
              ${it.categoria ? escapeHtml(it.categoria)+' 췅 ' : ''}
              ${it.unidade ? 'Unid: '+escapeHtml(it.unidade)+' 췅 ' : ''}
              Valor sugerido: R$ ${formatMoney(Number(it.valor)||0)}
            </div>
          </div>
        </div>
      `;
    });
    box.innerHTML = html;
  }

  /* utils */
  function escapeHtml(s){
    return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
  }
  function formatMoney(v){
    const n = Number(v||0);
    return n.toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2});
  }
</script>
