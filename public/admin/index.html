<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Painel Interno – TUFDS</title>
<style>
  :root{
    --bg:#f3f4f6; --card:#fff; --text:#111827; --muted:#6b7280;
    --border:#e5e7eb; --accent:#0f766e; --accent-2:#0d5f57;
  }
  *{ box-sizing:border-box }
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto;
    background:var(--bg); color:var(--text);
    display:flex; flex-direction:column; min-height:100vh;
  }

  /* Cabeçalho fixo */
  header{
    background:var(--accent);
    color:#fff;
    padding:16px 24px;
    display:flex; justify-content:space-between; align-items:center;
    box-shadow:0 2px 6px rgba(0,0,0,.1);
  }
  header h1{ margin:0; font-size:20px }
  header .user{
    display:flex; align-items:center; gap:10px;
    font-size:15px;
  }
  button.logout{
    background:#fff2; border:0; border-radius:999px;
    padding:6px 12px; color:#fff; cursor:pointer;
  }
  button.logout:hover{ background:#fff3 }

  /* Menu de abas */
  nav{
    background:#fff; border-bottom:1px solid var(--border);
    display:flex; gap:10px; padding:10px 16px;
    flex-wrap:wrap;
  }
  nav button{
    background:none; border:1px solid var(--border);
    border-radius:10px; padding:8px 14px;
    cursor:pointer; color:var(--text);
    font-weight:500; transition:.15s;
  }
  nav button:hover{ background:#f9fafb }
  nav button.active{
    background:var(--accent); color:#fff; border-color:var(--accent);
  }

  /* Conteúdo das abas */
  main{
    flex:1;
    padding:24px;
    max-width:1200px; margin:0 auto;
  }

  /* Loader simples */
  #loader{
    text-align:center; padding:40px; color:var(--muted);
  }
</style>
<script>
(async () => {
  try {
    const res = await fetch('/api/auth/me.js');
    const data = await res.json();
    if (!data.ok) throw new Error();
    document.getElementById('user-name').textContent = data.user.nome || data.user.email;
  } catch {
    window.location.href = '/public/login.html';
  }
})();

async function sair(){
  try{ await fetch('/api/auth/logout.js',{method:'POST'}); }
  finally{ window.location.href = '/public/login.html'; }
}

// Carrega o conteúdo de uma aba (partial HTML)
async function loadTab(file, btn){
  const main = document.querySelector('main');
  main.innerHTML = '<div id="loader">Carregando...</div>';

  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');

  try{
    const res = await fetch(file);
    if(!res.ok) throw new Error('Erro ao carregar.');
    const html = await res.text();
    main.innerHTML = html;

    // executa <script> do partial
    main.querySelectorAll("script").forEach(oldScript => {
      const newScript = document.createElement("script");
      if (oldScript.src) newScript.src = oldScript.src;
      else newScript.textContent = oldScript.textContent;
      document.body.appendChild(newScript);
      oldScript.remove();
    });

  }catch(e){
    main.innerHTML = '<p style="color:#b91c1c">Falha ao carregar o módulo.</p>';
  }
}
</script>
</head>

<body>
  <header>
    <h1>Painel Interno – TUFDS</h1>
    <div class="user">
      <span id="user-name">Filho do Sagrado</span>
      <button class="logout" onclick="sair()">Sair</button>
    </div>
  </header>

  <nav>
    <button class="active" onclick="loadTab('/public/admin/partials/FinanceiroView.html', this)">Transparência Financeira</button>
    <button onclick="loadTab('/public/admin/partials/Presencas.html', this)">Registro de Presenças</button>
    <button onclick="loadTab('/public/admin/partials/Faltas.html', this)">Controle de Faltas</button>
    <button onclick="loadTab('/public/admin/partials/Aulas.html', this)">Aulas de Desenvolvimento</button>
    <button onclick="loadTab('/public/admin/partials/Desenvolvimento.html', this)">Desenvolvimento Individual</button>
    <button onclick="loadTab('/public/admin/partials/Aniversariantes.html', this)">Aniversariantes</button>
  </nav>

   <main id="view">
    <!-- os partials carregam aqui -->
  </main>

  <script>
    // mantém o highlight da aba ativa (admin.js pode também trocar essa classe)
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.tab-btn');
      if (!btn) return;
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
    });

    async function logout(){
      try{ await fetch('/api/auth/logout.js',{method:'POST'}); }
      finally{ window.location.href='/public/login.html'; }
    }
  </script>

  <!-- controlador das abas/partials -->
   <script>
    // logout padrão
    async function logout() {
      try { await fetch('/api/auth/logout.js', { method: 'POST' }); }
      finally { window.location.href = '/public/login.html'; }
    }

    // carrega o conteúdo da aba (mantendo active correto)
    async function loadTab(file, btn) {
      const main = document.querySelector('#view');
      main.innerHTML = '<div style="text-align:center;padding:40px;color:#666">Carregando...</div>';

      // atualiza botões ativos
      document.querySelectorAll('nav.tabs button').forEach(b => b.classList.remove('active'));
      if (btn) btn.classList.add('active');

      try {
        const res = await fetch(file);
        if (!res.ok) throw new Error('Erro ao carregar página');
        const html = await res.text();
        main.innerHTML = html;

        // reexecuta scripts internos do partial
        main.querySelectorAll("script").forEach(oldScript => {
          const newScript = document.createElement("script");
          if (oldScript.src) newScript.src = oldScript.src;
          else newScript.textContent = oldScript.textContent;
          document.body.appendChild(newScript);
          oldScript.remove();
        });
      } catch (err) {
        main.innerHTML = `<p style="color:#b91c1c;text-align:center">Falha ao carregar: ${err.message}</p>`;
      }
    }

    // inicialização sincronizada com o botão ativo
    window.addEventListener('DOMContentLoaded', () => {
      const active = document.querySelector('nav.tabs button.active');
      if (active) {
        const defaultFile = {
          'Transparência Financeira': '/public/admin/partials/FinanceiroView.html',
          'Registro de Presenças': '/public/admin/partials/Presencas.html',
          'Controle de Faltas': '/public/admin/partials/Faltas.html',
          'Aulas de Desenvolvimento': '/public/admin/partials/Aulas.html',
          'Desenvolvimento Individual': '/public/admin/partials/Desenvolvimento.html',
          'Aniversariantes': '/public/admin/partials/Aniversariantes.html'
        }[active.textContent.trim()] || '/public/admin/partials/FinanceiroView.html';
        loadTab(defaultFile, active);
      }

      // registra os cliques nas abas
      document.querySelectorAll('nav.tabs button').forEach(btn => {
        btn.addEventListener('click', () => {
          const file = {
            'Transparência Financeira': '/public/admin/partials/FinanceiroView.html',
            'Registro de Presenças': '/public/admin/partials/Presencas.html',
            'Controle de Faltas': '/public/admin/partials/Faltas.html',
            'Aulas de Desenvolvimento': '/public/admin/partials/Aulas.html',
            'Desenvolvimento Individual': '/public/admin/partials/Desenvolvimento.html',
            'Aniversariantes': '/public/admin/partials/Aniversariantes.html'
          }[btn.textContent.trim()];
          if (file) loadTab(file, btn);
        });
      });
    });
  </script>

</body>
</html>
