<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Rifa – TUFDS</title>
<style>
  :root{ --accent:#0f766e; --muted:#6b7280; --border:#e5e7eb; --danger:#b91c1c; --ok:#15803d }
  body{ font-family:Arial,sans-serif; color:#111827 }
  .wrap{ max-width:900px; margin:28px auto; background:#fff; padding:20px; border-radius:14px; box-shadow:0 2px 10px rgba(0,0,0,.08) }
  h1{ margin:0 0 12px }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
  input,select,button{ padding:9px 12px; border:1px solid var(--border); border-radius:10px; font-size:14px }
  button{ background:var(--accent); color:#fff; border:none; cursor:pointer; font-weight:700 }
  button:disabled{ opacity:.6; cursor:not-allowed }
  .muted{ color:var(--muted); font-size:13px }
  .grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(80px,1fr)); gap:8px; margin-top:14px }
  .card{
    border:1px solid var(--border); border-radius:12px; padding:10px; text-align:center;
    display:flex; flex-direction:column; gap:6px; min-height:86px
  }
  .num{ font-weight:800; font-size:18px }
  .livre{ background:#f8fafc }
  .ocupado{ background:#fef2f2; border-color:#fecaca }
  .ocupado .who{ color:#991b1b; font-size:12px }
  .msg{ margin-top:12px; padding:10px; border-radius:10px; display:none; font-weight:700; text-align:center }
  .msg.ok{ background:#e8f5e9; color:var(--ok); display:block }
  .msg.err{ background:#fdecea; color:var(--danger); display:block }
  .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:8px 0 14px }
  .badge{ background:#eef2ff; color:#3730a3; border-radius:999px; padding:4px 10px; font-size:12px; font-weight:700 }
  dialog{ border:1px solid var(--border); border-radius:14px; padding:16px; max-width:420px }
  dialog form{ display:flex; flex-direction:column; gap:10px }
  .footer{ display:flex; gap:10px; justify-content:flex-end; margin-top:6px }
</style>
</head>
<body>
<div class="wrap" id="rifa-root">
  <h1>Rifa</h1>

  <div class="toolbar">
    <span class="muted">Gerar/Resetar rifa com</span>
    <input id="qtd" type="number" min="5" step="5" value="50" style="width:90px"/>
    <button id="btnCriar" type="button">Criar/Resetar</button>

    <span class="badge" id="badgeTot">Total: 0</span>
    <span class="badge" id="badgeVendidos">Vendidos: 0</span>
    <span class="badge" id="badgeLivres">Livres: 0</span>

    <button id="btnSortear" disabled>Sortear vencedor</button>
  </div>

  <div id="msg" class="msg"></div>

  <div id="grid" class="grid"></div>
</div>

<!-- Modal de compra -->
<dialog id="dlg">
  <form method="dialog" id="dlgForm">
    <h3 id="dlgTitle" style="margin:0 0 6px">Número</h3>
    <label>Nome do comprador</label>
    <input id="inpNome" type="text" required placeholder="Ex.: Maria Souza"/>
    <div class="footer">
      <button id="dlgCancel" type="button" style="background:#6b7280">Cancelar</button>
      <button id="dlgOk" type="submit">Confirmar</button>
    </div>
  </form>
</dialog>

<!-- ADICIONE ESTE SCRIPT APÓS O SCRIPT EXISTENTE -->
<script>
let RIFA = { total:0, vendidos:0, livres:0, numeros:[] };

function render() {
  const grid = document.getElementById('grid');
  const bTot = document.getElementById('badgeTot');
  const bVen = document.getElementById('badgeVendidos');
  const bLiv = document.getElementById('badgeLivres');

  grid.innerHTML = RIFA.numeros.map(n => `
    <div class="card ${n.nome ? 'ocupado' : 'livre'}" data-num="${n.numero}">
      <div class="num">#${n.numero}</div>
      ${n.nome ? `<div class="who">${n.nome}</div>` : `<div class="who muted">disponível</div>`}
    </div>
  `).join('');

  bTot.textContent = `Total: ${RIFA.total}`;
  bVen.textContent = `Vendidos: ${RIFA.vendidos}`;
  bLiv.textContent = `Livres: ${RIFA.livres}`;

  // clique para comprar (só nos livres)
  grid.querySelectorAll('.card.livre').forEach(card => {
    card.addEventListener('click', () => abrirCompra(Number(card.dataset.num)));
  });
}

function normalizeInit(d){
  const out = { total:0, vendidos:0, livres:0, numeros:[] };
  if (Array.isArray(d?.numeros)) {
    out.numeros = d.numeros.map(x => ({
      numero: Number(x.numero ?? x.num ?? x.id ?? x.n),
      nome: (x.nome ?? x.who ?? x.comprador ?? '').toString().trim() || null
    })).filter(x => Number.isFinite(x.numero));
  }
  out.total = Number(d?.total ?? out.numeros.length);
  if ((!out.numeros || out.numeros.length === 0) && out.total > 0) {
    out.numeros = Array.from({length: out.total}, (_,i) => ({ numero: i+1, nome: null }));
  }
  out.vendidos = Number(d?.vendidos ?? out.numeros.filter(n => !!n.nome).length);
  out.livres   = out.total - out.vendidos;
  return out;
}

async function refresh() {
  const res = await fetch('/api/rifa/init.js?ts=' + Date.now(), { cache: 'no-store' });
  const raw = await res.text();
  const data = JSON.parse(raw);
  if (!data.ok) throw new Error(data.message || 'Falha no init');
  RIFA = normalizeInit(data);
  render();
}

// === Comprar (POST) ===
async function comprar(numero, nome){
  const res = await fetch('/api/rifa/comprar.js', {
    method: 'POST',
    headers: { 'Content-Type':'application/json' },
    cache: 'no-store',
    body: JSON.stringify({ numero, nome })
  });
  const raw = await res.text();
  const data = JSON.parse(raw);
  if (!res.ok || data.ok === false) throw new Error(data.message || 'Falha ao comprar');
  // Recarrega da planilha e re-renderiza (evita ficar “livre” no front)
  await refresh();
}

// === Modal simples ===
function abrirCompra(numero){
  const dlg = document.getElementById('dlg');
  const title = document.getElementById('dlgTitle');
  const inp = document.getElementById('inpNome');
  title.textContent = `Comprar nº ${numero}`;
  inp.value = '';
  dlg.showModal();

  const onSubmit = async (ev) => {
    ev.preventDefault();
    const nome = inp.value.trim();
    if (!nome) return;
    try {
      await comprar(numero, nome);
      dlg.close();
      show(true, `Número ${numero} vendido para ${nome}.`);
    } catch(e) {
      show(false, e.message);
    } finally {
      form.removeEventListener('submit', onSubmit);
    }
  };
  const form = document.getElementById('dlgForm');
  form.addEventListener('submit', onSubmit);
  document.getElementById('dlgCancel').onclick = () => {
    form.removeEventListener('submit', onSubmit);
    dlg.close();
  };
}

// === Criar/Resetar já existente ===
async function configurar(){
  const n = parseInt(document.getElementById('qtd').value, 10);
  const btn = document.getElementById('btnCriar');
  btn.disabled = true; btn.textContent = 'Enviando...'; show(null,'');
  try{
    const r = await fetch('/api/rifa/configurar.js', {
      method:'POST', headers:{'Content-Type':'application/json'},
      cache:'no-store', body: JSON.stringify({ total:n })
    });
    const raw = await r.text(); const j = JSON.parse(raw);
    if (!r.ok || j.ok === false) throw new Error(j.message || 'Falha ao configurar');
    show(true, `Rifa criada/zerada com ${n} números.`);
    await refresh();
  } catch(e){ show(false, e.message); }
  finally{ btn.disabled = false; btn.textContent = 'Criar/Resetar'; }
}

// helpers de mensagem (igual você já tem)
function show(ok, text){
  const box = document.getElementById('msg');
  if (ok === null){ box.style.display='none'; return; }
  box.className = 'msg ' + (ok ? 'ok' : 'err');
  box.textContent = text;
  box.style.display = 'block';
}

// boot
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('btnCriar').addEventListener('click', e => {
    e.preventDefault(); configurar();
  });
  // 1ª carga
  refresh().catch(e => show(false, e.message));
});
</script>




</body>
</html>
