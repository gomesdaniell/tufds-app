<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Rifa â€“ TUFDS</title>
<style>
  :root{ --accent:#0f766e; --muted:#6b7280; --border:#e5e7eb; --danger:#b91c1c; --ok:#15803d }
  body{ font-family:Arial,sans-serif; color:#111827 }
  .wrap{ max-width:900px; margin:28px auto; background:#fff; padding:20px; border-radius:14px; box-shadow:0 2px 10px rgba(0,0,0,.08) }
  h1{ margin:0 0 12px }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
  input,select,button{ padding:9px 12px; border:1px solid var(--border); border-radius:10px; font-size:14px }
  button{ background:var(--accent); color:#fff; border:none; cursor:pointer; font-weight:700 }
  button:disabled{ opacity:.6; cursor:not-allowed }
  .muted{ color:var(--muted); font-size:13px }
  .grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(80px,1fr)); gap:8px; margin-top:14px }
  .card{
    border:1px solid var(--border); border-radius:12px; padding:10px; text-align:center;
    display:flex; flex-direction:column; gap:6px; min-height:86px
  }
  .num{ font-weight:800; font-size:18px }
  .livre{ background:#f8fafc }
  .ocupado{ background:#fef2f2; border-color:#fecaca }
  .ocupado .who{ color:#991b1b; font-size:12px }
  .msg{ margin-top:12px; padding:10px; border-radius:10px; display:none; font-weight:700; text-align:center }
  .msg.ok{ background:#e8f5e9; color:var(--ok); display:block }
  .msg.err{ background:#fdecea; color:var(--danger); display:block }
  .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:8px 0 14px }
  .badge{ background:#eef2ff; color:#3730a3; border-radius:999px; padding:4px 10px; font-size:12px; font-weight:700 }
  dialog{ border:1px solid var(--border); border-radius:14px; padding:16px; max-width:420px }
  dialog form{ display:flex; flex-direction:column; gap:10px }
  .footer{ display:flex; gap:10px; justify-content:flex-end; margin-top:6px }
</style>
</head>
<body>
<div class="wrap" id="rifa-root">
  <h1>Rifa</h1>

  <div class="toolbar">
    <span class="muted">Gerar/Resetar rifa com</span>
    <input id="qtd" type="number" min="5" step="5" value="50" style="width:90px"/>
    <button id="btnCriar" type="button">Criar/Resetar</button>

    <span class="badge" id="badgeTot">Total: 0</span>
    <span class="badge" id="badgeVendidos">Vendidos: 0</span>
    <span class="badge" id="badgeLivres">Livres: 0</span>

    <button id="btnSortear" disabled>Sortear vencedor</button>
  </div>

  <div id="msg" class="msg"></div>

  <div id="grid" class="grid"></div>
</div>

<!-- Modal de compra -->
<dialog id="dlg">
  <form method="dialog" id="dlgForm">
    <h3 id="dlgTitle" style="margin:0 0 6px">NÃºmero</h3>
    <label>Nome do comprador</label>
    <input id="inpNome" type="text" required placeholder="Ex.: Maria Souza"/>
    <div class="footer">
      <button id="dlgCancel" type="button" style="background:#6b7280">Cancelar</button>
      <button id="dlgOk" type="submit">Confirmar</button>
    </div>
  </form>
</dialog>

<!-- ADICIONE ESTE SCRIPT APÃ“S O SCRIPT EXISTENTE -->
<script>
(() => {
  const $grid   = document.getElementById('grid');
  const $msg    = document.getElementById('msg');
  const $badgeTot = document.getElementById('badgeTot');
  const $badgeVendidos = document.getElementById('badgeVendidos');
  const $badgeLivres   = document.getElementById('badgeLivres');
  const $btnSortear = document.getElementById('btnSortear');

  // Modal
  const $dlg      = document.getElementById('dlg');
  const $dlgForm  = document.getElementById('dlgForm');
  const $dlgTitle = document.getElementById('dlgTitle');
  const $inpNome  = document.getElementById('inpNome');

  let numeros = [];     // [{numero: 1, nome: null}, ...]
  let numeroSelecionado = null;

  function toast(ok, text){
    if (!$msg) return alert(text);
    $msg.className = 'msg ' + (ok ? 'ok' : 'err');
    $msg.textContent = text;
    $msg.style.display = 'block';
  }

  function normalizeInitPayload(dataRaw) {
    // Tenta aceitar formatos diferentes vindos do backend
    // Esperado: { ok:true, total, vendidos, livres, numeros: [{numero, nome}] }
    const d = dataRaw || {};
    const out = { total: 0, vendidos: 0, livres: 0, numeros: [] };

    if (Array.isArray(d.numeros)) {
      out.numeros = d.numeros.map(it => {
        // aceita chaves alternativas
        const numero = it.numero ?? it.num ?? it.n ?? it.id ?? null;
        const nome   = it.nome ?? it.who ?? it.comprador ?? it.owner ?? null;
        return { numero, nome: (nome && String(nome).trim()) || null };
      }).filter(it => typeof it.numero === 'number');
    } else if (Array.isArray(d)) {
      // Se veio direto um array (fallback)
      out.numeros = d.map((it, i) => {
        if (typeof it === 'number') return { numero: it, nome: null };
        if (typeof it === 'object' && it !== null) {
          const numero = it.numero ?? it.num ?? it.n ?? i+1;
          const nome   = it.nome ?? it.who ?? it.comprador ?? null;
          return { numero, nome: (nome && String(nome).trim()) || null };
        }
        return { numero: i+1, nome: null };
      });
    }

    // Totais
    out.total    = d.total ?? out.numeros.length;
    out.vendidos = d.vendidos ?? out.numeros.filter(x => !!x.nome).length;
    out.livres   = d.livres   ?? (out.total - out.vendidos);
    return out;
  }

  function renderGrid(list) {
    $grid.innerHTML = '';
    list.forEach(item => {
      const card = document.createElement('div');
      const ocupado = !!item.nome;
      card.className = 'card ' + (ocupado ? 'ocupado' : 'livre');
      card.innerHTML = `
        <div class="num">#${item.numero}</div>
        <div class="who">${ocupado ? (item.nome) : '<span class="muted">disponÃ­vel</span>'}</div>
        ${ocupado ? '' : '<button type="button" class="btnComprar">Vender</button>'}
      `;

      if (!ocupado) {
        card.querySelector('.btnComprar').addEventListener('click', () => {
          numeroSelecionado = item.numero;
          $dlgTitle.textContent = `NÃºmero #${item.numero}`;
          $inpNome.value = '';
          if (typeof $dlg.showModal === 'function') $dlg.showModal();
          else $dlg.setAttribute('open','');
        });
      }

      $grid.appendChild(card);
    });
  }

  async function load() {
    try {
      $grid.innerHTML = '<div class="muted">Carregando rifaâ€¦</div>';

      const res = await fetch('/api/rifa/init.js', { cache: 'no-store' });
      const raw = await res.text();
      let data;
      try { data = JSON.parse(raw); } catch { throw new Error(raw || `${res.status} ${res.statusText}`); }
      if (!res.ok || data.ok === false) throw new Error(data?.message || `${res.status} ${res.statusText}`);

      const norm = normalizeInitPayload(data);
      numeros = norm.numeros;

      // Badges
      $badgeTot.textContent      = `Total: ${norm.total}`;
      $badgeVendidos.textContent = `Vendidos: ${norm.vendidos}`;
      $badgeLivres.textContent   = `Livres: ${norm.livres}`;

      // Sortear fica habilitado sÃ³ quando nÃ£o hÃ¡ livres
      $btnSortear.disabled = norm.livres > 0;

      renderGrid(numeros);
    } catch (e) {
      toast(false, 'Falha ao carregar rifa: ' + e.message);
      $grid.innerHTML = '';
    }
  }

  // Comprar (atribuir nome) â€“ submit do modal
  $dlgForm.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    const nome = ($inpNome.value || '').trim();
    if (!nome) { toast(false, 'Informe o nome do comprador.'); return; }
    if (!numeroSelecionado) { toast(false, 'NÃºmero invÃ¡lido.'); return; }

    try {
      const res = await fetch('/api/rifa/comprar.js', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ numero: numeroSelecionado, nome })
      });
      const raw = await res.text();
      let data;
      try { data = JSON.parse(raw); } catch { throw new Error(raw || `${res.status} ${res.statusText}`); }
      if (!res.ok || data.ok === false) throw new Error(data?.message || `${res.status} ${res.statusText}`);

      toast(true, `NÃºmero #${numeroSelecionado} vendido para ${nome}.`);
      // fecha modal
      if (typeof $dlg.close === 'function') $dlg.close();
      else $dlg.removeAttribute('open');
      numeroSelecionado = null;

      await load();
    } catch (e) {
      toast(false, 'Falha ao vender: ' + e.message);
    }
  });

  // Cancelar modal
  document.getElementById('dlgCancel').addEventListener('click', () => {
    if (typeof $dlg.close === 'function') $dlg.close();
    else $dlg.removeAttribute('open');
  });

  // Sortear vencedor
  $btnSortear.addEventListener('click', async () => {
    try {
      $btnSortear.disabled = true;
      const res = await fetch('/api/rifa/sortear.js', { method: 'POST' });
      const raw = await res.text();
      let data;
      try { data = JSON.parse(raw); } catch { throw new Error(raw || `${res.status} ${res.statusText}`); }
      if (!res.ok || data.ok === false) throw new Error(data?.message || `${res.status} ${res.statusText}`);

      const v = data.vencedor || {};
      const numero = v.numero ?? v.num ?? v.n ?? '?';
      const nome   = v.nome   ?? v.who ?? v.comprador ?? 'â€”';
      toast(true, `ðŸŽ‰ Vencedor: #${numero} â€“ ${nome}`);
    } catch (e) {
      toast(false, 'Falha ao sortear: ' + (e.message || e));
      $btnSortear.disabled = false; // reabilita em caso de erro
    }
  });

  // Exponho load() para ser chamado pelo outro script apÃ³s reset
  window.load = load;

  // Primeira carga da grade ao abrir o partial
  load();
})();
</script>


</body>
</html>
