<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Rifa – TUFDS</title>
<style>
  :root{ --accent:#0f766e; --muted:#6b7280; --border:#e5e7eb; --danger:#b91c1c; --ok:#15803d }
  body{ font-family:Arial,sans-serif; color:#111827 }
  .wrap{ max-width:900px; margin:28px auto; background:#fff; padding:20px; border-radius:14px; box-shadow:0 2px 10px rgba(0,0,0,.08) }
  h1{ margin:0 0 12px }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
  input,select,button{ padding:9px 12px; border:1px solid var(--border); border-radius:10px; font-size:14px }
  button{ background:var(--accent); color:#fff; border:none; cursor:pointer; font-weight:700 }
  button:disabled{ opacity:.6; cursor:not-allowed }
  .muted{ color:var(--muted); font-size:13px }
  .grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(80px,1fr)); gap:8px; margin-top:14px }
  .card{
    border:1px solid var(--border); border-radius:12px; padding:10px; text-align:center;
    display:flex; flex-direction:column; gap:6px; min-height:86px
  }
  .num{ font-weight:800; font-size:18px }
  .livre{ background:#f8fafc }
  .ocupado{ background:#fef2f2; border-color:#fecaca }
  .ocupado .who{ color:#991b1b; font-size:12px }
  .msg{ margin-top:12px; padding:10px; border-radius:10px; display:none; font-weight:700; text-align:center }
  .msg.ok{ background:#e8f5e9; color:var(--ok); display:block }
  .msg.err{ background:#fdecea; color:var(--danger); display:block }
  .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:8px 0 14px }
  .badge{ background:#eef2ff; color:#3730a3; border-radius:999px; padding:4px 10px; font-size:12px; font-weight:700 }
  dialog{ border:1px solid var(--border); border-radius:14px; padding:16px; max-width:420px }
  dialog form{ display:flex; flex-direction:column; gap:10px }
  .footer{ display:flex; gap:10px; justify-content:flex-end; margin-top:6px }
</style>
</head>
<body>
<div class="wrap" id="rifa-root">
  <h1>Rifa</h1>

  <div class="toolbar">
    <span class="muted">Gerar/Resetar rifa com</span>
    <input id="qtd" type="number" min="5" step="5" value="50" style="width:90px"/>
    <button id="btnCriar">Criar/Resetar</button>

    <span class="badge" id="badgeTot">Total: 0</span>
    <span class="badge" id="badgeVendidos">Vendidos: 0</span>
    <span class="badge" id="badgeLivres">Livres: 0</span>

    <button id="btnSortear" disabled>Sortear vencedor</button>
  </div>

  <div id="msg" class="msg"></div>

  <div id="grid" class="grid"></div>
</div>

<!-- Modal de compra -->
<dialog id="dlg">
  <form method="dialog" id="dlgForm">
    <h3 id="dlgTitle" style="margin:0 0 6px">Número</h3>
    <label>Nome do comprador</label>
    <input id="inpNome" type="text" required placeholder="Ex.: Maria Souza"/>
    <div class="footer">
      <button id="dlgCancel" type="button" style="background:#6b7280">Cancelar</button>
      <button id="dlgOk" type="submit">Confirmar</button>
    </div>
  </form>
</dialog>

<script>
  // ... (resto do script igual)

  async function configurar(){
    const n = parseInt($qtd.value,10);
    if (!n || n < 1) { show(false,'Informe uma quantidade válida.'); return; }

    $btnCriar.disabled = true; 
    $btnCriar.textContent = 'Enviando...';
    try {
      const res = await fetch('/api/rifa/configurar.js', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        cache: 'no-store',
        body: JSON.stringify({ total:n })
      });

      // lê como texto e tenta JSON (pra evitar “Unexpected token 'A'...”)
      const raw = await res.text();
      let data;
      try { data = JSON.parse(raw); }
      catch { throw new Error(raw || `${res.status} ${res.statusText}`); }

      if (!res.ok || data.ok === false) {
        throw new Error(data?.message || `${res.status} ${res.statusText}`);
      }

      show(true, `Rifa criada/zerada com ${n} números.`);
      await load();
    } catch(e){
      console.error('configurar() ->', e);
      show(false, `Falha ao criar/zerar: ${e.message}`);
    } finally {
      $btnCriar.disabled = false; 
      $btnCriar.textContent = 'Criar/Resetar';
    }
  }

  // ... (resto do script igual)
</script>

</body>
</html>
