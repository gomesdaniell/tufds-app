<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Rifa â€“ TUFDS</title>
<style>
  :root{ --accent:#0f766e; --muted:#6b7280; --border:#e5e7eb; --danger:#b91c1c; --ok:#15803d }
  body{ font-family:Arial,sans-serif; color:#111827 }
  .wrap{ max-width:900px; margin:28px auto; background:#fff; padding:20px; border-radius:14px; box-shadow:0 2px 10px rgba(0,0,0,.08) }
  h1{ margin:0 0 12px }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
  input,select,button{ padding:9px 12px; border:1px solid var(--border); border-radius:10px; font-size:14px }
  button{ background:var(--accent); color:#fff; border:none; cursor:pointer; font-weight:700 }
  button:disabled{ opacity:.6; cursor:not-allowed }
  .muted{ color:var(--muted); font-size:13px }
  .grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(80px,1fr)); gap:8px; margin-top:14px }
  .card{
    border:1px solid var(--border); border-radius:12px; padding:10px; text-align:center;
    display:flex; flex-direction:column; gap:6px; min-height:86px
  }
  .num{ font-weight:800; font-size:18px }
  .livre{ background:#f8fafc }
  .ocupado{ background:#fef2f2; border-color:#fecaca }
  .ocupado .who{ color:#991b1b; font-size:12px }
  .msg{ margin-top:12px; padding:10px; border-radius:10px; display:none; font-weight:700; text-align:center }
  .msg.ok{ background:#e8f5e9; color:var(--ok); display:block }
  .msg.err{ background:#fdecea; color:var(--danger); display:block }
  .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:8px 0 14px }
  .badge{ background:#eef2ff; color:#3730a3; border-radius:999px; padding:4px 10px; font-size:12px; font-weight:700 }
  dialog{ border:1px solid var(--border); border-radius:14px; padding:16px; max-width:420px }
  dialog form{ display:flex; flex-direction:column; gap:10px }
  .footer{ display:flex; gap:10px; justify-content:flex-end; margin-top:6px }
</style>
</head>
<body>
<div class="wrap" id="rifa-root">
  <h1>Rifa</h1>

  <div class="toolbar">
    <span class="muted">Gerar/Resetar rifa com</span>
    <input id="qtd" type="number" min="5" step="5" value="50" style="width:90px"/>
    <button id="btnCriar">Criar/Resetar</button>

    <span class="badge" id="badgeTot">Total: 0</span>
    <span class="badge" id="badgeVendidos">Vendidos: 0</span>
    <span class="badge" id="badgeLivres">Livres: 0</span>

    <button id="btnSortear" disabled>Sortear vencedor</button>
  </div>

  <div id="msg" class="msg"></div>

  <div id="grid" class="grid"></div>
</div>

<!-- Modal de compra -->
<dialog id="dlg">
  <form method="dialog" id="dlgForm">
    <h3 id="dlgTitle" style="margin:0 0 6px">NÃºmero</h3>
    <label>Nome do comprador</label>
    <input id="inpNome" type="text" required placeholder="Ex.: Maria Souza"/>
    <div class="footer">
      <button id="dlgCancel" type="button" style="background:#6b7280">Cancelar</button>
      <button id="dlgOk" type="submit">Confirmar</button>
    </div>
  </form>
</dialog>

<script>
async function safeFetchJSON(url, opts) {
  const res = await fetch(url, opts);
  const raw = await res.text();
  let data;
  try { data = JSON.parse(raw); }
  catch { throw new Error(raw || res.status+' '+res.statusText); }
  if (!res.ok || data?.ok === false) throw new Error(data?.message || (res.status+' '+res.statusText));
  return data;
}

const el = id => document.getElementById(id);
const $grid = el('grid');
const $msg  = el('msg');
const $qtd  = el('qtd');
const $btnCriar = el('btnCriar');
const $btnSortear = el('btnSortear');
const $badgeTot = el('badgeTot');
const $badgeVendidos = el('badgeVendidos');
const $badgeLivres = el('badgeLivres');

let STATE = { total: 0, itens: [] }; // itens: [{numero, nome|null}]

function show(ok, text){
  $msg.className = 'msg ' + (ok ? 'ok':'err');
  $msg.textContent = text;
  $msg.style.display = 'block';
  if (ok) setTimeout(()=> $msg.style.display='none', 2500);
}

function render(){
  const vendidos = STATE.itens.filter(i=>i.nome).length;
  const livres   = STATE.itens.length - vendidos;
  $badgeTot.textContent = 'Total: ' + STATE.itens.length;
  $badgeVendidos.textContent = 'Vendidos: ' + vendidos;
  $badgeLivres.textContent = 'Livres: ' + livres;
  $btnSortear.disabled = !(STATE.itens.length>0 && vendidos===STATE.itens.length);

  $grid.innerHTML = STATE.itens.map(i=>{
    if (i.nome) {
      return `
        <div class="card ocupado">
          <div class="num">#${i.numero}</div>
          <div class="who">Vendido: ${i.nome}</div>
        </div>
      `;
    } else {
      return `
        <button class="card livre" data-num="${i.numero}">
          <div class="num">#${i.numero}</div>
          <div class="muted">DisponÃ­vel</div>
        </button>
      `;
    }
  }).join('');
}

async function load(){
  const data = await safeFetchJSON('/api/rifa/init.js');
  STATE.total = data.total || 0;
  STATE.itens = Array.isArray(data.itens) ? data.itens : [];
  render();
}

async function configurar(){
  const n = parseInt($qtd.value,10);
  if (!n || n<1) return show(false,'Informe uma quantidade vÃ¡lida.');
  await safeFetchJSON('/api/rifa/configurar.js', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ total:n })
  });
  show(true,'Rifa criada/zerada com '+n+' nÃºmeros.');
  load();
}

function promptComprar(numero){
  const dlg = el('dlg');
  const title = el('dlgTitle');
  const inp = el('inpNome');
  title.textContent = 'Comprar nÃºmero #'+numero;
  inp.value = '';
  dlg.showModal();

  const cancel = el('dlgCancel');
  cancel.onclick = ()=> dlg.close('cancel');

  const form = el('dlgForm');
  form.onsubmit = async (ev)=>{
    ev.preventDefault();
    const nome = inp.value.trim();
    if (!nome) return;
    try{
      await safeFetchJSON('/api/rifa/comprar.js', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ numero, nome })
      });
      dlg.close('ok');
      show(true, 'NÃºmero #'+numero+' vendido para '+nome);
      await load();
    }catch(e){
      show(false, e.message);
    }
  };
}

async function sortear(){
  try{
    const r = await safeFetchJSON('/api/rifa/sortear.js', { method:'POST' });
    const { numero, nome } = r.vencedor || {};
    show(true, `ðŸŽ‰ Vencedor: #${numero} â€” ${nome}`);
    await load();
  }catch(e){
    show(false, e.message);
  }
}

document.addEventListener('click', (ev)=>{
  const btn = ev.target.closest('button.livre[data-num]');
  if (!btn) return;
  const n = parseInt(btn.getAttribute('data-num'),10);
  promptComprar(n);
});

$btnCriar.addEventListener('click', configurar);
$btnSortear.addEventListener('click', sortear);

document.addEventListener('DOMContentLoaded', load);
</script>
</body>
</html>
