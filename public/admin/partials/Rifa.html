<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Rifa â€“ TUFDS</title>
<style>
  :root{ --accent:#0f766e; --muted:#6b7280; --border:#e5e7eb; --danger:#b91c1c; --ok:#15803d }
  body{ font-family:Arial,sans-serif; color:#111827 }
  .wrap{ max-width:900px; margin:28px auto; background:#fff; padding:20px; border-radius:14px; box-shadow:0 2px 10px rgba(0,0,0,.08) }
  h1{ margin:0 0 12px }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
  input,select,button{ padding:9px 12px; border:1px solid var(--border); border-radius:10px; font-size:14px }
  button{ background:var(--accent); color:#fff; border:none; cursor:pointer; font-weight:700 }
  button:disabled{ opacity:.6; cursor:not-allowed }
  .muted{ color:var(--muted); font-size:13px }
  .grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(80px,1fr)); gap:8px; margin-top:14px }
  .card{
    border:1px solid var(--border); border-radius:12px; padding:10px; text-align:center;
    display:flex; flex-direction:column; gap:6px; min-height:86px
  }
  .num{ font-weight:800; font-size:18px }
  .livre{ background:#f8fafc }
  .ocupado{ background:#fef2f2; border-color:#fecaca }
  .ocupado .who{ color:#991b1b; font-size:12px }
  .msg{ margin-top:12px; padding:10px; border-radius:10px; display:none; font-weight:700; text-align:center }
  .msg.ok{ background:#e8f5e9; color:var(--ok); display:block }
  .msg.err{ background:#fdecea; color:var(--danger); display:block }
  .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:8px 0 14px }
  .badge{ background:#eef2ff; color:#3730a3; border-radius:999px; padding:4px 10px; font-size:12px; font-weight:700 }
  dialog{ border:1px solid var(--border); border-radius:14px; padding:16px; max-width:420px }
  dialog form{ display:flex; flex-direction:column; gap:10px }
  .footer{ display:flex; gap:10px; justify-content:flex-end; margin-top:6px }
</style>
</head>
<body>
<div class="wrap" id="rifa-root">
  <h1>Rifa</h1>

  <div class="toolbar">
    <span class="muted">Gerar/Resetar rifa com</span>
    <input id="qtd" type="number" min="5" step="5" value="50" style="width:90px"/>
    <button id="btnCriar" type="button">Criar/Resetar</button>

    <span class="badge" id="badgeTot">Total: 0</span>
    <span class="badge" id="badgeVendidos">Vendidos: 0</span>
    <span class="badge" id="badgeLivres">Livres: 0</span>

    <button id="btnSortear" disabled>Sortear vencedor</button>
  </div>

  <div id="msg" class="msg"></div>

  <div id="grid" class="grid"></div>
</div>

<!-- Modal -->
<dialog id="dlg">
  <form method="dialog" id="dlgForm">
    <h3 id="dlgTitle" style="margin:0 0 6px">NÃºmero</h3>
    <label>Nome do comprador</label>
    <input id="inpNome" type="text" required placeholder="Ex.: Maria Souza"/>
    <div class="footer">
      <button id="dlgCancel" type="button" style="background:#6b7280">Cancelar</button>
      <button id="dlgOk" type="submit">Confirmar</button>
    </div>
  </form>
</dialog>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const $btnCriar = document.getElementById('btnCriar');
  const $qtd = document.getElementById('qtd');
  const $msg = document.getElementById('msg');
  const $grid = document.getElementById('grid');
  const $badgeTot = document.getElementById('badgeTot');
  const $badgeVend = document.getElementById('badgeVendidos');
  const $badgeLiv = document.getElementById('badgeLivres');
  const $btnSort = document.getElementById('btnSortear');
  const $dlg = document.getElementById('dlg');
  const $dlgForm = document.getElementById('dlgForm');
  const $dlgTitle = document.getElementById('dlgTitle');
  const $inpNome = document.getElementById('inpNome');
  const $dlgCancel = document.getElementById('dlgCancel');
  let numeroSelecionado = null;

  const toast = (ok, txt) => {
    $msg.className = 'msg ' + (ok ? 'ok' : 'err');
    $msg.textContent = txt;
    $msg.style.display = 'block';
  };

  const toJson = async (res) => {
    const raw = await res.text();
    try { return JSON.parse(raw); }
    catch { throw new Error(raw || `${res.status} ${res.statusText}`); }
  };

  const normalizeInit = (d) => {
    const out = { total:0, vendidos:0, livres:0, numeros:[] };
    if (Array.isArray(d?.numeros)) {
      out.numeros = d.numeros.map(x => ({
        numero: Number(x.numero ?? x.num ?? x.id),
        nome: (x.nome ?? x.comprador ?? '').trim() || null
      }));
    }
    out.total = Number(d?.total ?? out.numeros.length);
    out.vendidos = out.numeros.filter(n => n.nome).length;
    out.livres = out.total - out.vendidos;
    return out;
  };

  function renderGrid(list){
    $grid.innerHTML = '';
    list.forEach(item => {
      const ocupado = !!item.nome;
      const card = document.createElement('div');
      card.className = 'card ' + (ocupado ? 'ocupado' : 'livre');
      card.innerHTML = `
        <div class="num">#${item.numero}</div>
        <div class="who">${ocupado ? item.nome : '<span class="muted">disponÃ­vel</span>'}</div>
        ${ocupado ? '' : '<button class="btnComprar">Vender</button>'}
      `;
      if (!ocupado) {
        card.querySelector('.btnComprar').addEventListener('click', () => {
          numeroSelecionado = item.numero;
          $dlgTitle.textContent = \`NÃºmero #\${item.numero}\`;
          $inpNome.value = '';
          $dlg.showModal();
        });
      }
      $grid.appendChild(card);
    });
  }

  async function load(){
    try {
      const res = await fetch('/api/rifa/init.js?ts=' + Date.now(), { cache:'no-store' });
      const data = await toJson(res);
      if (!res.ok || data.ok === false) throw new Error(data?.message || 'Falha ao carregar');
      const norm = normalizeInit(data);
      $badgeTot.textContent = `Total: ${norm.total}`;
      $badgeVend.textContent = `Vendidos: ${norm.vendidos}`;
      $badgeLiv.textContent = `Livres: ${norm.livres}`;
      $btnSort.disabled = norm.livres > 0;
      renderGrid(norm.numeros);
    } catch(e) { toast(false, e.message); }
  }

  async function configurar(){
    const n = parseInt($qtd.value);
    if (!n || n < 1) return toast(false, 'Informe um nÃºmero vÃ¡lido.');
    $btnCriar.disabled = true; $btnCriar.textContent = 'Criando...';
    try {
      const r = await fetch('/api/rifa/configurar.js', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ total: n })
      });
      const j = await toJson(r);
      if (!r.ok || j.ok === false) throw new Error(j.message);
      toast(true, `Rifa criada/zerada com ${n} nÃºmeros.`);
      await load();
    } catch(e){ toast(false, e.message); }
    finally { $btnCriar.disabled = false; $btnCriar.textContent = 'Criar/Resetar'; }
  }

  async function comprar(numero, nome){
    const r = await fetch('/api/rifa/comprar.js', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ numero, nome })
    });
    const j = await toJson(r);
    if (!r.ok || j.ok === false) throw new Error(j.message);
  }

  async function sortear(){
    const r = await fetch('/api/rifa/sortear.js',{method:'POST'});
    const j = await toJson(r);
    if (!r.ok || j.ok === false) throw new Error(j.message);
    const v = j.vencedor || {};
    toast(true, `ðŸŽ‰ Vencedor: #${v.numero} â€“ ${v.nome}`);
  }

  // eventos
  $btnCriar.addEventListener('click', configurar);
  $dlgCancel.addEventListener('click', ()=> $dlg.close());
  $dlgForm.addEventListener('submit', async ev => {
    ev.preventDefault();
    const nome = $inpNome.value.trim();
    if (!nome) return toast(false, 'Digite o nome.');
    try {
      await comprar(numeroSelecionado, nome);
      $dlg.close();
      toast(true, `NÃºmero #${numeroSelecionado} vendido para ${nome}.`);
      // aguarda sincronizar e recarrega
      await new Promise(r=>setTimeout(r,300));
      await load();
    } catch(e){ toast(false, e.message); }
  });
  $btnSort.addEventListener('click', sortear);

  load();
});
</script>
</body>
</html>
