<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Transparência Financeira – TUFDS</title>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #f3f4f6;
        margin: 0;
        padding: 0;
    }

    .container {
        max-width: 1250px;
        margin: 0 auto;
        padding: 30px;
    }

    h1 {
        font-size: 32px;
        margin-bottom: 5px;
    }

    p.desc {
        margin-top: -5px;
        color: #444;
        font-size: 15px;
    }

    .filtros {
        display: flex;
        gap: 20px;
        margin-bottom: 25px;
    }

    select {
        padding: 8px 10px;
        font-size: 16px;
        border-radius: 6px;
        border: 1px solid #bbb;
    }

    .cards {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 18px;
        margin-bottom: 20px;
    }

    .card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        border: 1px solid #ddd;
    }

    .card h3 {
        font-size: 18px;
        margin: 0 0 10px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .card .valor {
        font-size: 26px;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .card small {
        color: #444;
        display: block;
        margin-top: 5px;
    }

    /* Tooltip ℹ️ */
    .info {
        cursor: help;
        font-size: 16px;
        opacity: 0.7;
    }
    .info:hover {
        opacity: 1;
    }

    /* Badge Adimplência */
    .badge {
        padding: 6px 12px;
        border-radius: 30px;
        font-size: 15px;
        font-weight: bold;
        margin-left: 10px;
    }

    .linha {
        display: grid;
        grid-template-columns: 1fr 140px;
        padding: 8px 0;
        border-bottom: 1px solid #e0e0e0;
    }

    .titulo-tabela {
        font-weight: bold;
        font-size: 18px;
        margin-top: 25px;
        margin-bottom: 10px;
    }
</style>
</head>

<body>
<div class="container">

    <h1>Transparência Financeira – TUFDS</h1>
    <p class="desc">Visão consolidada por mês: receitas, despesas, saldo e situação das mensalidades (sem expor nomes).</p>

    <div class="filtros">
        <div>
            <label>Ano</label><br>
            <select id="ano"></select>
        </div>

        <div>
            <label>Mês</label><br>
            <select id="mes"></select>
        </div>
    </div>

    <!-- CARDS RESUMO -->
    <div class="cards">

        <!-- RECEITAS -->
        <div class="card" id="card-receitas">
            <h3>
                RECEITAS DO MÊS
                <span class="info" title="Inclui: mensalidades recebidas, doações, ofertas, lojinha e outras entradas.">ℹ️</span>
            </h3>
            <div class="valor" id="valor-receitas">R$ 0,00</div>
            <small>Inclui todas as entradas.</small>
        </div>

        <!-- DESPESAS -->
        <div class="card" id="card-despesas">
            <h3>
                DESPESAS DO MÊS
                <span class="info" title="Inclui todas as saídas: compras, insumos, manutenção, sistemas, eventos, etc.">ℹ️</span>
            </h3>
            <div class="valor" id="valor-despesas">R$ 0,00</div>
            <small>Custos gerais do terreiro.</small>
        </div>

        <!-- SALDO -->
        <div class="card" id="card-saldo">
            <h3>
                SALDO DO MÊS
                <span class="info" title="Saldo = Receitas do mês – Despesas do mês.">ℹ️</span>
            </h3>
            <div class="valor" id="valor-saldo">R$ 0,00</div>
            <small>Resultado final do mês.</small>
        </div>

        <!-- MENSALIDADES -->
        <div class="card">
            <h3>
                MENSALIDADES
                <span class="info" title="Mostra o total previsto, já recebido e em aberto (sem expor nomes).">ℹ️</span>
                <span id="taxa-adimplencia" class="badge">0%</span>
            </h3>
            <div class="valor" id="valor-mensalidades">R$ 0,00</div>
            <small id="mensal-sub">Recebido: R$ 0,00 | Em aberto: R$ 0,00</small>
        </div>
    </div>

    <!-- RECEITAS POR CATEGORIA -->
    <div class="titulo-tabela">Receitas por categoria</div>
    <div id="receitas-cat"></div>

    <!-- DESPESAS POR CATEGORIA -->
    <div class="titulo-tabela">Despesas por categoria</div>
    <div id="despesas-cat"></div>

    <small style="margin-top:40px; display:block; color:#444;">
        * Este painel apresenta apenas números consolidados. Nenhum nome é exibido, garantindo transparência e respeito à privacidade.
    </small>

</div>

<script>
function formata(v) {
    return v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
}

/* CORES DO SALDO */
function aplicarCorSaldo(valor) {
    const card = document.getElementById("card-saldo");

    if (valor < 0) {
        card.style.background = "#ffe5e5";
        card.style.border = "1px solid #f55";
    } else {
        card.style.background = "#eaf4ff";
        card.style.border = "1px solid #a8c8f0";
    }
}

/* BADGE DE ADIMPLÊNCIA */
function atualizarBadgeAdimplencia(valor) {
    const badge = document.getElementById("taxa-adimplencia");

    badge.textContent = valor.toFixed(0) + "%";

    if (valor >= 75) {
        badge.style.background = "#31c653";
        badge.style.color = "white";
    } else if (valor >= 40) {
        badge.style.background = "#ffdd57";
        badge.style.color = "#333";
    } else {
        badge.style.background = "#ff6b6b";
        badge.style.color = "white";
    }
}

/* MONTA TABELAS DE CATEGORIA */
function renderCategorias(containerId, lista) {
    const div = document.getElementById(containerId);
    div.innerHTML = "";

    lista.forEach(l => {
        const row = document.createElement("div");
        row.className = "linha";
        row.innerHTML = `<span>${l.categoria}</span><span>${formata(l.valor)}</span>`;
        div.appendChild(row);
    });
}

/* CARREGAR ANO/MÊS E DADOS */
google.script.run.withSuccessHandler(init).getFinanceiroInit();

function init(info) {
    const selAno = document.getElementById("ano");
    const selMes = document.getElementById("mes");

    info.anos.forEach(a => {
        const op = document.createElement("option");
        op.value = a;
        op.textContent = a;
        selAno.appendChild(op);
    });

    info.meses.forEach((m, i) => {
        const op = document.createElement("option");
        op.value = i + 1;
        op.textContent = m;
        selMes.appendChild(op);
    });

    selAno.value = info.anoAtual;
    selMes.value = info.mesAtual;

    carregarDados();

    selAno.onchange = carregarDados;
    selMes.onchange = carregarDados;
}

function carregarDados() {
    const ano = document.getElementById("ano").value;
    const mes = document.getElementById("mes").value;

    google.script.run
        .withSuccessHandler(render)
        .getFinanceiroDados(Number(ano), Number(mes));
}

function render(data) {

    document.getElementById("valor-receitas").textContent = formata(data.receitas);
    document.getElementById("valor-despesas").textContent = formata(data.despesas);
    document.getElementById("valor-saldo").textContent = formata(data.saldoMes);
    document.getElementById("valor-mensalidades").textContent = formata(data.mensalidadesPrev);

    document.getElementById("mensal-sub").textContent =
        `Recebido: ${formata(data.mensalidadesPagas)} | Em aberto: ${formata(data.mensalidadesAbertas)}`;

    aplicarCorSaldo(data.saldoMes);
    atualizarBadgeAdimplencia(data.adimplencia);

    renderCategorias("receitas-cat", data.receitasCat);
    renderCategorias("despesas-cat", data.despesasCat);
}
</script>

</body>
</html>
