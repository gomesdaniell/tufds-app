<!-- public/admin/partials/FinanceiroView.html -->
<style>
  /* escopo local do partial */
  .fin-wrap { font-family: Arial, sans-serif; }
  .fin-container { max-width:1250px; margin:0 auto; padding:30px; }
  .fin-topbar{ display:flex; justify-content:space-between; align-items:center; margin-bottom:10px }
  .fin-title{ margin:0 0 5px; font-size:32px }
  .fin-desc{ margin:0; color:#444; font-size:15px }
  .fin-filtros{ display:flex; gap:20px; margin:18px 0 25px }
  .fin-filtros select{ padding:8px 10px; font-size:16px; border-radius:6px; border:1px solid #bbb }
  .fin-cards{ display:grid; grid-template-columns:repeat(4,1fr); gap:18px; margin-bottom:20px }
  .fin-card{ background:#fff; padding:20px; border-radius:12px; border:1px solid #ddd }
  .fin-card h3{ font-size:18px; margin:0 0 10px; display:flex; gap:6px; align-items:center }
  .fin-valor{ font-size:26px; font-weight:bold; margin-bottom:10px }
  .fin-info{ cursor:help; font-size:16px; opacity:.7 } .fin-info:hover{ opacity:1 }
  .fin-badge{ padding:6px 12px; border-radius:30px; font-size:15px; font-weight:bold; margin-left:10px }
  .fin-linha{ display:grid; grid-template-columns:1fr 140px; padding:8px 0; border-bottom:1px solid #e0e0e0 }
  .fin-tit-tab{ font-weight:bold; font-size:18px; margin:25px 0 10px }
  .fin-saldo-pos{ background:#eaf4ff; border:1px solid #a8c8f0 }
  .fin-saldo-neg{ background:#ffe5e5; border:1px solid #f55 }
  .fin-logout{ border:0; background:#0f766e; color:#fff; padding:8px 14px; border-radius:999px; cursor:pointer }
</style>

<div class="fin-wrap">
  <div class="fin-container">
    <div class="fin-topbar">
      <div>
        <h2 class="fin-title">Transparência Financeira – TUFDS</h2>
        <p class="fin-desc">Visão consolidada por mês: receitas, despesas, saldo e mensalidades (sem nomes).</p>
      </div>
      <button class="fin-logout" id="finBtnLogout" type="button">Sair</button>
    </div>

    <div class="fin-filtros">
      <div>
        <label>Ano</label><br>
        <select id="finAno"></select>
      </div>
      <div>
        <label>Mês</label><br>
        <select id="finMes"></select>
      </div>
    </div>

    <div class="fin-cards">
      <div class="fin-card" id="finCardReceitas">
        <h3>RECEITAS DO MÊS <span class="fin-info" title="Mensalidades, doações, ofertas, lojinha e outras entradas.">ℹ️</span></h3>
        <div class="fin-valor" id="finValorReceitas">R$ 0,00</div>
        <small>Inclui todas as entradas.</small>
      </div>

      <div class="fin-card" id="finCardDespesas">
        <h3>DESPESAS DO MÊS <span class="fin-info" title="Compras, insumos, manutenção, sistemas, eventos, etc.">ℹ️</span></h3>
        <div class="fin-valor" id="finValorDespesas">R$ 0,00</div>
        <small>Custos gerais do terreiro.</small>
      </div>

      <div class="fin-card" id="finCardSaldo">
        <h3>SALDO DO MÊS <span class="fin-info" title="Saldo = Receitas – Despesas.">ℹ️</span></h3>
        <div class="fin-valor" id="finValorSaldo">R$ 0,00</div>
        <small>Resultado final do mês.</small>
      </div>

      <div class="fin-card">
        <h3>MENSALIDADES
          <span class="fin-info" title="Total previsto, recebido e em aberto (sem nomes).">ℹ️</span>
          <span id="finBadgeAdi" class="fin-badge">0%</span>
        </h3>
        <div class="fin-valor" id="finValorMensalidades">R$ 0,00</div>
        <small id="finMensalSub">Recebido: R$ 0,00 | Em aberto: R$ 0,00</small>
      </div>
    </div>

    <div class="fin-tit-tab">Receitas por categoria</div>
    <div id="finReceitasCat"></div>

    <div class="fin-tit-tab">Despesas por categoria</div>
    <div id="finDespesasCat"></div>

    <small style="margin-top:40px; display:block; color:#444;">
      * Painel mostra apenas números consolidados (sem exposição de nomes).
    </small>
  </div>
</div>

<script>
(async function(){
  // garante que está logado (se cair, volta ao login)
  try{
    const me = await fetch('/api/auth/me.js');
    const j = await me.json();
    if (!j.ok) { window.location.href = '/public/login.html'; return; }
  }catch{ window.location.href = '/public/login.html'; return; }

  const $ = (sel) => document.querySelector(sel);
  const fmt = v => Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

  function pintaSaldo(v){
    const card = $('#finCardSaldo');
    card.classList.remove('fin-saldo-pos','fin-saldo-neg');
    if (Number(v) < 0) card.classList.add('fin-saldo-neg');
    else card.classList.add('fin-saldo-pos');
  }
  function badgeAdi(p){
    const b = $('#finBadgeAdi');
    const x = Number(p||0);
    b.textContent = x.toFixed(0)+'%';
    if (x >= 75){ b.style.background='#31c653'; b.style.color='#fff'; }
    else if (x >= 40){ b.style.background='#ffdd57'; b.style.color='#333'; }
    else { b.style.background='#ff6b6b'; b.style.color='#fff'; }
  }
  function renderCats(id, lista){
    const div = $(id); div.innerHTML='';
    (lista||[]).forEach(l=>{
      const row = document.createElement('div');
      row.className='fin-linha';
      row.innerHTML = `<span>${l.categoria}</span><span>${fmt(l.valor)}</span>`;
      div.appendChild(row);
    });
  }

  async function loadInit(){
    const r = await fetch('/api/fin/init.js'); const j = await r.json();
    if (!j.ok) throw new Error('Falha init');
    const selAno = $('#finAno'), selMes = $('#finMes');
    j.anos.forEach(a=>{ const o=document.createElement('option'); o.value=a; o.textContent=a; selAno.appendChild(o); });
    j.meses.forEach((m,i)=>{ const o=document.createElement('option'); o.value=i+1; o.textContent=m; selMes.appendChild(o); });
    selAno.value = j.anoAtual; selMes.value = j.mesAtual;
    selAno.onchange = loadDados; selMes.onchange = loadDados;
    await loadDados();
  }

  async function loadDados(){
    const ano = $('#finAno').value, mes = $('#finMes').value;
    const r = await fetch(`/api/fin/dados.js?ano=${ano}&mes=${mes}`);
    const d = await r.json();
    if (!d.ok) throw new Error('Falha dados');

    $('#finValorReceitas').textContent = fmt(d.receitas);
    $('#finValorDespesas').textContent = fmt(d.despesas);
    $('#finValorSaldo').textContent    = fmt(d.saldoMes);
    $('#finValorMensalidades').textContent = fmt(d.mensalidadesPrev);
    $('#finMensalSub').textContent = `Recebido: ${fmt(d.mensalidadesPagas)} | Em aberto: ${fmt(d.mensalidadesAbertas)}`;

    pintaSaldo(d.saldoMes);
    badgeAdi(d.adimplencia);
    renderCats('#finReceitasCat', d.receitasCat);
    renderCats('#finDespesasCat', d.despesasCat);
  }

  $('#finBtnLogout')?.addEventListener('click', async ()=>{
    try{ await fetch('/api/auth/logout.js',{method:'POST'}); }finally{
      window.location.href = '/public/login.html';
    }
  });

  await loadInit();
})();
</script>
