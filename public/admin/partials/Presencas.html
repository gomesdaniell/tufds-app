<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Registro de Presença – TUFDS</title>
<style>
  body{font-family:Arial,sans-serif;background:#f8f9fb;margin:0;color:#333}
  .container{max-width:680px;margin:28px auto;background:#fff;padding:22px;border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
  h1{margin:0 0 14px}
  label{font-weight:700;display:block;margin:10px 0 6px}
  select{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;font-size:14px}
  .actions{display:flex;justify-content:flex-end;margin-top:14px}
  button{background:#111827;color:#fff;border:0;padding:10px 18px;border-radius:8px;cursor:pointer;font-weight:700}
  button:hover{background:#333}
  #msg{display:none;margin-top:12px;padding:10px;border-radius:8px;text-align:center;font-weight:700}
  #msg.ok{background:#e8f5e9;color:#256029}
  #msg.err{background:#fdecea;color:#a12721}
</style>
</head>
<body>
  <div id="presencas-root" class="container">
    <h1>Registro de Presença – TUFDS</h1>

    <label>Nome</label>
    <select id="nome"></select>

    <div class="actions">
      <button id="enviar">Registrar presença</button>
    </div>

    <div id="msg"></div>
  </div>

<script>
(() => {
  const ROOT = document.getElementById('presencas-root');
  if (!ROOT || ROOT.dataset.inited === '1') return;
  ROOT.dataset.inited = '1';

  const $ = sel => ROOT.querySelector(sel);

  // Envio
  $('#enviar').addEventListener('click', async () => {
    const nome = $('#nome').value;
    if (!nome) return alert('Selecione o nome.');

    const btn = $('#enviar'), msg = $('#msg');
    btn.disabled = true; btn.textContent = 'Enviando...';
    msg.style.display = 'none'; msg.className = ''; msg.textContent = '';

    try {
      const res = await fetch('/api/presencas/salvar.js', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ nome })
      });

      const raw = await res.text();
      let data;
      try { data = JSON.parse(raw); }
      catch { throw new Error(raw || 'Resposta não-JSON do servidor.'); }

      if (!res.ok || !data.ok) throw new Error(data?.message || 'Falha ao salvar.');

      btn.disabled = false; btn.textContent = 'Registrar presença';
      msg.className = 'ok';
      msg.textContent = '✅ Presença registrada com sucesso!';
      msg.style.display = 'block';
    } catch (err) {
      btn.disabled = false; btn.textContent = 'Registrar presença';
      msg.className = 'err';
      msg.textContent = '❌ ' + (err.message || 'Erro ao salvar');
      msg.style.display = 'block';
    }
  });

  // Init – carrega nomes da aba Cadastro
  (async () => {
    const msg = $('#msg');
    try {
      const r = await fetch('/api/presencas/init.js');
      const j = await r.json();
      if (!j.ok) throw new Error(j.message || 'Erro ao carregar nomes');

      const nomes = Array.isArray(j.nomes) ? j.nomes : [];
      const sel = $('#nome');
      sel.innerHTML = '<option value="">Selecione...</option>' +
        nomes.map(n => `<option>${n}</option>`).join('');
    } catch (e) {
      msg.className = 'err';
      msg.textContent = '❌ Erro ao carregar nomes: ' + (e.message || e);
      msg.style.display = 'block';
    }
  })();
})();
</script>
</body>
</html>
