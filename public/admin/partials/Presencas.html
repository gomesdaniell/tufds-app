<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Lista de Presen√ßa ‚Äì TUFDS</title>
<style>
  body{font-family:Arial, sans-serif; background:#f8f9fb; margin:0; color:#333}
  .wrap{max-width:680px; margin:32px auto; background:#fff; padding:22px; border-radius:14px; box-shadow:0 2px 10px rgba(0,0,0,.08)}
  h1{margin:0 0 8px}
  label{font-weight:700; display:block; margin:10px 0 6px}
  select, input, textarea{width:100%; padding:10px; border:1px solid #ccc; border-radius:8px; font-size:14px; box-sizing:border-box}
  .codigo-box{margin:8px 0 16px; padding:14px; border:2px dashed #64748b; border-radius:12px; background:#f1f5f9; text-align:center}
  .codigo{font-family:monospace; font-size:28px; letter-spacing:3px; font-weight:800; color:#111}
  .muted{font-size:12px; color:#666}
  .row{display:flex; gap:12px; flex-wrap:wrap}
  .row>*{flex:1 1 220px}
  button{background:#111827; color:#fff; border:0; padding:10px 16px; border-radius:8px; cursor:pointer; font-weight:700}
  button:hover{background:#333}
  #msg{display:none; margin-top:12px; padding:10px; border-radius:8px; text-align:center; font-weight:700}
  #msg.ok{background:#e8f5e9; color:#256029}
  #msg.err{background:#fdecea; color:#a12721}
  #geoStatus{margin-bottom:8px}
  #geoStatus.ok{color:#15803d}
  #geoStatus.err{color:#b91c1c}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Lista de Presen√ßa ‚Äì TUFDS</h1>
    <div id="geoStatus" class="muted">‚è≥ Verificando sua localiza√ß√£o‚Ä¶</div>

    <div class="codigo-box">
      <div class="muted">C√≥digo da gira (atualiza automaticamente)</div>
      <div id="codigo" class="codigo">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
      <div class="muted">Copie e digite abaixo exatamente como aparece.</div>
    </div>

    <label>Seu nome</label>
    <select id="nome" disabled></select>

    <div class="row">
      <div>
        <label>C√≥digo da gira</label>
        <input id="codigoInput" type="text" placeholder="Digite o c√≥digo exibido acima" disabled/>
      </div>
      <div>
        <label>Observa√ß√£o (opcional)</label>
        <input id="obs" type="text" placeholder="Atraso, justificativa, etc." disabled/>
      </div>
    </div>

    <div style="margin-top:12px">
      <button id="btnEnviar" disabled>Registrar Presen√ßa</button>
    </div>

    <div id="msg"></div>
  </div>

<script>
  // üìç coordenadas / raio -3.072586021397572,-60.042981419063146 
  const LAT_TERREIRO   = -3.0744035321383296;
  const LON_TERREIRO   = -59.99549091003758;
  const RAIO_MAX_METROS= 300;

  const elCodigo = document.getElementById('codigo');
  const elNome   = document.getElementById('nome');
  const elInput  = document.getElementById('codigoInput');
  const elObs    = document.getElementById('obs');
  const elMsg    = document.getElementById('msg');
  const btnEnviar= document.getElementById('btnEnviar');
  const geoStatus= document.getElementById('geoStatus');

  function showMsg(ok, text){
    elMsg.className = ok ? 'ok' : 'err';
    elMsg.textContent = text;
    elMsg.style.display = 'block';
    if (ok) setTimeout(()=> elMsg.style.display='none', 4000);
  }

  // Haversine
  const toRad = g => g * Math.PI/180;
  function distanciaEmMetros(lat1, lon1, lat2, lon2){
    const R=6371000, dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
    const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  function habilitarFormulario(msgOk){
    elNome.disabled=false; elInput.disabled=false; elObs.disabled=false; btnEnviar.disabled=false;
    geoStatus.textContent=msgOk; geoStatus.className='muted ok';
  }
  function bloquearFormulario(msgErro){
    elNome.disabled=true; elInput.disabled=true; elObs.disabled=true; btnEnviar.disabled=true;
    geoStatus.textContent=msgErro; geoStatus.className='muted err';
  }

  // 1) Localiza√ß√£o
  function solicitarLocalizacao(){
    if (!navigator.geolocation){
      bloquearFormulario('Seu dispositivo n√£o permite localiza√ß√£o. Fale com a dire√ß√£o do terreiro.');
      return;
    }
    navigator.geolocation.getCurrentPosition(
      pos=>{
        const { latitude:lat, longitude:lon } = pos.coords;
        const dist = distanciaEmMetros(lat, lon, LAT_TERREIRO, LON_TERREIRO);
        if (dist <= RAIO_MAX_METROS){
          habilitarFormulario(`‚úÖ Localiza√ß√£o confirmada. Dist√¢ncia aproximada: ${dist.toFixed(0)}m do terreiro.`);
        }else{
          bloquearFormulario('‚ùå Voc√™ est√° distante do terreiro. Presen√ßa s√≥ pode ser registrada no local.');
        }
      },
      err=>{
        console.error(err);
        bloquearFormulario('‚ùå N√£o foi poss√≠vel obter sua localiza√ß√£o. Ative o GPS/permiss√£o e recarregue.');
      },
      { enableHighAccuracy:true, timeout:15000 }
    );
  }

  // 2) Carregar nomes + c√≥digo atual via google.script.run
  function init(){
    google.script.run
      .withSuccessHandler(data=>{
        const nomes = data?.nomes || [];
        elNome.innerHTML = '<option value="">Selecione...</option>' + nomes.map(n=>`<option>${n}</option>`).join('');
        elCodigo.textContent = data?.codigoAtual || '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
        startPolling();
      })
      .withFailureHandler(e=>{
        showMsg(false, 'Erro ao carregar: ' + (e?.message || e));
      })
      .getPresencaInitData();
  }

  // 3) Polling do c√≥digo (5s) via google.script.run
  let pollTimer=null;
  function startPolling(){
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = setInterval(()=>{
      google.script.run
        .withSuccessHandler(st=>{
          if (st?.codigo) elCodigo.textContent = st.codigo;
        })
        .getCodigoState();
    }, 5000);
  }

  // 4) Enviar presen√ßa
  btnEnviar.addEventListener('click', ()=>{
    const nome   = (elNome.value||'').trim();
    const codigo = (elInput.value||'').trim().toUpperCase();
    const observacao = (elObs.value||'').trim();

    if (!nome)   return showMsg(false,'Selecione o seu nome.');
    if (!codigo) return showMsg(false,'Informe o c√≥digo da gira.');

    btnEnviar.disabled=true; btnEnviar.textContent='Enviando...'; elMsg.style.display='none';

    google.script.run
      .withSuccessHandler(res=>{
        btnEnviar.disabled=false; btnEnviar.textContent='Registrar Presen√ßa';
        if (res?.ok){
          showMsg(true,'‚úÖ Presen√ßa registrada com sucesso.');
          elInput.value=''; elObs.value='';
        }else{
          showMsg(false,'Erro inesperado ao registrar.');
        }
      })
      .withFailureHandler(err=>{
        btnEnviar.disabled=false; btnEnviar.textContent='Registrar Presen√ßa';
        showMsg(false,'‚ùå ' + (err?.message || err));
      })
      .salvarPresenca({ nome, codigo, observacao });
  });

  // ‚úÖ Bootstrap mesmo sendo partial injetado
  function bootstrap(){ solicitarLocalizacao(); init(); }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', bootstrap, { once:true });
  }else{
    bootstrap();
  }
</script>
</body>
</html>
