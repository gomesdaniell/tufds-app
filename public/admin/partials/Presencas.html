<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Lista de Presença – TUFDS</title>
<style>
  body{font-family:Arial, sans-serif; background:#f8f9fb; margin:0; color:#333}
  .wrap{max-width:680px; margin:32px auto; background:#fff; padding:22px; border-radius:14px; box-shadow:0 2px 10px rgba(0,0,0,.08)}
  h1{margin:0 0 8px}
  label{font-weight:700; display:block; margin:10px 0 6px}
  select, input, textarea{width:100%; padding:10px; border:1px solid #ccc; border-radius:8px; font-size:14px; box-sizing:border-box}
  .codigo-box{margin:8px 0 16px; padding:14px; border:2px dashed #64748b; border-radius:12px; background:#f1f5f9; text-align:center}
  .codigo{font-family:monospace; font-size:28px; letter-spacing:3px; font-weight:800; color:#111}
  .muted{font-size:12px; color:#666}
  .row{display:flex; gap:12px; flex-wrap:wrap}
  .row>*{flex:1 1 220px}
  button{background:#111827; color:#fff; border:0; padding:10px 16px; border-radius:8px; cursor:pointer; font-weight:700}
  button:hover{background:#333}
  #msg{display:none; margin-top:12px; padding:10px; border-radius:8px; text-align:center; font-weight:700}
  #msg.ok{background:#e8f5e9; color:#256029}
  #msg.err{background:#fdecea; color:#a12721}
  #geoStatus{margin-bottom:8px}
  #geoStatus.ok{color:#15803d}
  #geoStatus.err{color:#b91c1c}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Lista de Presença – TUFDS</h1>
    <div id="geoStatus" class="muted">⏳ Verificando sua localização…</div>

    <div class="codigo-box">
      <div class="muted">Código da gira (atualiza automaticamente)</div>
      <div id="codigo" class="codigo">••••••</div>
      <div class="muted">Copie e digite abaixo exatamente como aparece.</div>
    </div>

    <label>Seu nome</label>
    <select id="nome" disabled></select>

    <div class="row">
      <div>
        <label>Código da gira</label>
        <input id="codigoInput" type="text" placeholder="Digite o código exibido acima" disabled/>
      </div>
      <div>
        <label>Observação (opcional)</label>
        <input id="obs" type="text" placeholder="Atraso, justificativa, etc." disabled/>
      </div>
    </div>

    <div style="margin-top:12px">
      <button id="btnEnviar" disabled>Registrar Presença</button>
    </div>

    <div id="msg"></div>
  </div>

<script>
  // coordenadas / raio -3.072586021397572,-60.042981419063146 
  const LAT_TERREIRO = -3.0743713919553697;
  const LON_TERREIRO = -59.99540507934922;
  const RAIO_MAX_METROS = 300;

  // endpoints (mesmo padrão dos outros módulos)
  const EP_INIT   = '/api/presencas/init.js';
  const EP_COD    = '/api/presencas/codigo.js';
  const EP_SALVAR = '/api/presencas/salvar.js';

  const elCodigo = document.getElementById('codigo');
  const elNome   = document.getElementById('nome');
  const elInput  = document.getElementById('codigoInput');
  const elObs    = document.getElementById('obs');
  const elMsg    = document.getElementById('msg');
  const btnEnviar= document.getElementById('btnEnviar');
  const geoStatus= document.getElementById('geoStatus');

  function showMsg(ok, text){
    elMsg.className = ok ? 'ok' : 'err';
    elMsg.textContent = text;
    elMsg.style.display = 'block';
    if (ok) setTimeout(()=> elMsg.style.display='none', 4000);
  }

  // haversine
  const toRad = g => g * Math.PI / 180;
  function distanciaEmMetros(lat1, lon1, lat2, lon2){
    const R = 6371000;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
      Math.sin(dLat/2)**2 +
      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
      Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  function habilitarFormulario(msgOk){
    elNome.disabled = false;
    elInput.disabled = false;
    elObs.disabled = false;
    btnEnviar.disabled = false;
    if (msgOk){
      geoStatus.textContent = msgOk;
      geoStatus.className = 'muted ok';
    }
  }

  function bloquearFormulario(msgErro){
    elNome.disabled = true;
    elInput.disabled = true;
    elObs.disabled = true;
    btnEnviar.disabled = true;
    geoStatus.textContent = msgErro;
    geoStatus.className = 'muted err';
  }

  // localização
  function solicitarLocalizacao(){
    if (!navigator.geolocation){
      bloquearFormulario('Seu dispositivo não permite localização. Fale com a direção do terreiro.');
      return;
    }
    navigator.geolocation.getCurrentPosition(
      pos => {
        const { latitude: lat, longitude: lon } = pos.coords;
        const dist = distanciaEmMetros(lat, lon, LAT_TERREIRO, LON_TERREIRO);
        if (dist <= RAIO_MAX_METROS){
          habilitarFormulario(`✅ Localização confirmada. Distância aproximada: ${dist.toFixed(0)}m do terreiro.`);
        } else {
          bloquearFormulario('❌ Sua localização está muito distante do terreiro. Presença só pode ser registrada já no terreiro.');
        }
      },
      err => {
        console.error(err);
        bloquearFormulario('❌ Não foi possível obter sua localização. Ative o GPS/permissão de localização e recarregue a página.');
      },
      { enableHighAccuracy:true, timeout:15000 }
    );
  }

  // fetch helpers (robustos contra HTML de erro)
  async function getJSON(url){
    const r = await fetch(url, { cache:'no-store' });
    const t = await r.text();
    let j; try { j = JSON.parse(t); } catch { throw new Error(t || 'Resposta não-JSON'); }
    if (!r.ok || j.ok === false) throw new Error(j.message || 'Erro na requisição');
    return j;
  }
  async function postJSON(url, body){
    const r = await fetch(url, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(body || {})
    });
    const t = await r.text();
    let j; try { j = JSON.parse(t); } catch { throw new Error(t || 'Resposta não-JSON'); }
    if (!r.ok || j.ok === false) throw new Error(j.message || 'Erro na requisição');
    return j;
  }

  // init (nomes + código)
  async function init(){
    try{
      const data = await getJSON(EP_INIT);
      const nomes = data.nomes || [];
      elNome.innerHTML = '<option value="">Selecione...</option>' + nomes.map(n=>`<option>${n}</option>`).join('');
      elCodigo.textContent = data.codigoAtual || '••••••';
      startPolling();
    }catch(e){
      showMsg(false, 'Erro ao carregar: ' + e.message);
    }
  }

  // polling do código (5s)
  let pollTimer = null;
  function startPolling(){
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = setInterval(async ()=>{
      try{
        const st = await getJSON(EP_COD);
        if (st && st.codigo) elCodigo.textContent = st.codigo;
      }catch(e){ /* silencioso */ }
    }, 5000);
  }

  // enviar presença
  btnEnviar.addEventListener('click', async ()=>{
    const nome = (elNome.value || '').trim();
    const codigo = (elInput.value || '').trim().toUpperCase();
    const observacao = (elObs.value || '').trim();

    if (!nome)   return showMsg(false, 'Selecione o seu nome.');
    if (!codigo) return showMsg(false, 'Informe o código da gira.');

    btnEnviar.disabled = true; btnEnviar.textContent = 'Enviando...';
    elMsg.style.display = 'none';

    try{
      await postJSON(EP_SALVAR, { nome, codigo, observacao });
      btnEnviar.disabled = false; btnEnviar.textContent = 'Registrar Presença';
      showMsg(true, '✅ Presença registrada com sucesso.');
      elInput.value = '';
      elObs.value   = '';
    }catch(e){
      btnEnviar.disabled = false; btnEnviar.textContent = 'Registrar Presença';
      showMsg(false, '❌ ' + e.message);
    }
  });

  // ✅ bootstrap também quando o partial é injetado
  function bootstrap(){
    solicitarLocalizacao();
    init();
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', bootstrap, { once:true });
  } else {
    bootstrap();
  }
</script>
</body>
</html>
