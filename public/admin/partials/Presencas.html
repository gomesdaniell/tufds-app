<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Lista de Presen√ßa ‚Äì TUFDS</title>
<style>
  body{font-family:Arial, sans-serif; background:#f8f9fb; margin:0; color:#333}
  .wrap{max-width:680px; margin:32px auto; background:#fff; padding:22px; border-radius:14px; box-shadow:0 2px 10px rgba(0,0,0,.08)}
  h1{margin:0 0 8px}
  label{font-weight:700; display:block; margin:10px 0 6px}
  select, input{width:100%; padding:10px; border:1px solid #ccc; border-radius:8px; font-size:14px; box-sizing:border-box}
  .muted{font-size:12px; color:#666}
  .row{display:flex; gap:12px; flex-wrap:wrap}
  .row>*{flex:1 1 220px}
  button{background:#111827; color:#fff; border:0; padding:10px 16px; border-radius:8px; cursor:pointer; font-weight:700}
  button:hover{background:#333}
  #msg{display:none; margin-top:12px; padding:10px; border-radius:8px; text-align:center; font-weight:700}
  #msg.ok{background:#e8f5e9; color:#256029}
  #msg.err{background:#fdecea; color:#a12721}
  #geoStatus{margin-bottom:8px}
  #geoStatus.ok{color:#15803d}
  #geoStatus.err{color:#b91c1c}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Lista de Presen√ßa ‚Äì TUFDS</h1>
    <div id="geoStatus" class="muted">‚è≥ Verificando sua localiza√ß√£o‚Ä¶</div>

    <label>Seu nome</label>
    <select id="nome" disabled></select>

    <div class="row">
      <div>
        <label>Observa√ß√£o (opcional)</label>
        <input id="obs" type="text" placeholder="Atraso, justificativa, etc." disabled/>
      </div>
    </div>

    <div style="margin-top:12px">
      <button id="btnEnviar" disabled>Registrar Presen√ßa</button>
    </div>

    <div id="msg"></div>
  </div>

<script>
  // üìç Coordenadas do terreiro (ajuste se precisar)-3.072586021397572, -60.042981419063146
  const LAT_TERREIRO = -3.074317824981607;
  const LON_TERREIRO = -59.99532997749692;
  const RAIO_MAX_METROS = 300;

  const elNome   = document.getElementById('nome');
  const elObs    = document.getElementById('obs');
  const elMsg    = document.getElementById('msg');
  const btnEnviar= document.getElementById('btnEnviar');
  const geoStatus= document.getElementById('geoStatus');

  // Guardaremos a √∫ltima posi√ß√£o v√°lida para enviar ao backend
  let lastLat = null;
  let lastLon = null;

  // Util: mensagens
  function showMsg(ok, text){
    elMsg.className = ok ? 'ok' : 'err';
    elMsg.textContent = text;
    elMsg.style.display = 'block';
    if (ok) setTimeout(()=> elMsg.style.display='none', 4000);
  }

  // Haversine helpers
  function toRad(g){ return g * Math.PI / 180; }
  function distanciaEmMetros(lat1, lon1, lat2, lon2){
    const R = 6371000; // metros
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
      Math.sin(dLat/2)**2 +
      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
      Math.sin(dLon/2)**2;
    return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  function habilitarFormulario(msgOk){
    elNome.disabled = false;
    elObs.disabled = false;
    btnEnviar.disabled = false;
    if (msgOk){
      geoStatus.textContent = msgOk;
      geoStatus.className = 'muted ok';
    }
  }

  function bloquearFormulario(msgErro){
    elNome.disabled = true;
    elObs.disabled = true;
    btnEnviar.disabled = true;
    geoStatus.textContent = msgErro;
    geoStatus.className = 'muted err';
  }

  // 1) Checa geolocaliza√ß√£o: se ok, habilita; se n√£o, bloqueia
  function solicitarLocalizacao(){
    if (!navigator.geolocation){
      bloquearFormulario('Seu dispositivo n√£o permite localiza√ß√£o. Fale com a dire√ß√£o do terreiro.');
      return;
    }

    navigator.geolocation.getCurrentPosition(
      pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const dist = distanciaEmMetros(lat, lon, LAT_TERREIRO, LON_TERREIRO);

        if (dist <= RAIO_MAX_METROS){
          lastLat = lat; lastLon = lon;
          habilitarFormulario(`‚úÖ Localiza√ß√£o confirmada. Dist√¢ncia aproximada: ${dist.toFixed(0)}m do terreiro.`);
        } else {
          bloquearFormulario('‚ùå Sua localiza√ß√£o est√° distante do terreiro. A presen√ßa s√≥ pode ser registrada no local.');
        }
      },
      err => {
        console.error(err);
        bloquearFormulario('‚ùå N√£o foi poss√≠vel obter sua localiza√ß√£o. Ative o GPS/permiss√£o de localiza√ß√£o e recarregue a p√°gina.');
      },
      {
        enableHighAccuracy: true,
        timeout: 15000
      }
    );
  }

  // 2) Carrega nomes (ativos) do backend
  async function carregarNomes(){
    try{
      const res = await fetch('/api/presencas/init.js');
      const j = await res.json();
      if (!j.ok) throw new Error(j.message || 'Falha ao carregar nomes.');
      elNome.innerHTML = '<option value="">Selecione...</option>' + (j.nomes||[]).map(n=>`<option>${n}</option>`).join('');
    }catch(e){
      showMsg(false, 'Erro ao carregar nomes: ' + e.message);
    }
  }

  // 3) Envia presen√ßa
  btnEnviar.addEventListener('click', async ()=>{
    const nome = (elNome.value || '').trim();
    const observacao = (elObs.value || '').trim();
    if (!nome) return showMsg(false, 'Selecione o seu nome.');

    btnEnviar.disabled = true; btnEnviar.textContent = 'Enviando...';
    elMsg.style.display = 'none';

    try{
      const res = await fetch('/api/presencas/salvar.js', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          nome,
          observacao,
          lat: lastLat,
          lon: lastLon
        })
      });
      const data = await res.json();
      if (!res.ok || !data.ok) throw new Error(data?.message || 'Falha ao salvar.');

      btnEnviar.disabled = false; btnEnviar.textContent = 'Registrar Presen√ßa';
      showMsg(true, '‚úÖ Presen√ßa registrada com sucesso.');
      elObs.value = '';

    }catch(e){
      btnEnviar.disabled = false; btnEnviar.textContent = 'Registrar Presen√ßa';
      showMsg(false, '‚ùå ' + e.message);
    }
  });

  document.addEventListener('DOMContentLoaded', ()=>{
    solicitarLocalizacao();
    carregarNomes();
  });
</script>
</body>
</html>
