<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Lista de Presen√ßa ‚Äì TUFDS</title>
<style>
  body{font-family:Arial, sans-serif; background:#f8f9fb; margin:0; color:#333}
  .wrap{max-width:680px; margin:32px auto; background:#fff; padding:22px; border-radius:14px; box-shadow:0 2px 10px rgba(0,0,0,.08)}
  h1{margin:0 0 8px}
  label{font-weight:700; display:block; margin:10px 0 6px}
  select, input{width:100%; padding:10px; border:1px solid #ccc; border-radius:8px; font-size:14px; box-sizing:border-box}
  .muted{font-size:12px; color:#666}
  .row{display:flex; gap:12px; flex-wrap:wrap}
  .row>*{flex:1 1 220px}
  button{background:#111827; color:#fff; border:0; padding:10px 16px; border-radius:8px; cursor:pointer; font-weight:700}
  button:hover{background:#333}
  #msg{display:none; margin-top:12px; padding:10px; border-radius:8px; text-align:center; font-weight:700}
  #msg.ok{background:#e8f5e9; color:#256029}
  #msg.err{background:#fdecea; color:#a12721}
  #geoStatus{margin-bottom:10px}
  #geoStatus.ok{color:#15803d}
  #geoStatus.err{color:#b91c1c}
  .btn-ghost{background:#0f766e; border:0; border-radius:10px; padding:8px 12px; font-weight:700}
  .btn-ghost:hover{background:#0d5f57}
  .actions{display:flex; gap:8px; align-items:center; margin:8px 0 16px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Lista de Presen√ßa ‚Äì TUFDS</h1>

    <div id="geoStatus" class="muted">Clique em <b>Permitir localiza√ß√£o</b> para liberar o formul√°rio.</div>
    <div class="actions">
      <button id="btnGeo" class="btn-ghost">Permitir localiza√ß√£o</button>
      <button id="btnRetry" class="btn-ghost" style="display:none">Tentar novamente</button>
      <span id="geoHint" class="muted"></span>
    </div>

    <label>Seu nome</label>
    <select id="nome" disabled></select>

    <div class="row">
      <div>
        <label>Observa√ß√£o (opcional)</label>
        <input id="obs" type="text" placeholder="Atraso, justificativa, etc." disabled/>
      </div>
    </div>

    <div style="margin-top:12px">
      <button id="btnEnviar" disabled>Registrar Presen√ßa</button>
    </div>

    <div id="msg"></div>
  </div>

<script>
  // üìç Coordenadas do terreiro (mesmas do seu projeto) -3.072586021397572,-60.042981419063146
  const LAT_TERREIRO = -3.074382105349791;
  const LON_TERREIRO = -59.99540507934922;
  const RAIO_MAX_METROS = 300;

  const elNome    = document.getElementById('nome');
  const elObs     = document.getElementById('obs');
  const btnEnviar = document.getElementById('btnEnviar');
  const geoStatus = document.getElementById('geoStatus');
  const elMsg     = document.getElementById('msg');

  function showMsg(ok, text){
    elMsg.className = ok ? 'ok' : 'err';
    elMsg.textContent = text;
    elMsg.style.display = 'block';
    if (ok) setTimeout(()=> elMsg.style.display='none', 4000);
  }

  // Haversine
  const toRad = g => g * Math.PI / 180;
  function distanciaEmMetros(lat1, lon1, lat2, lon2){
    const R = 6371000;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 +
              Math.cos(toRad(lat1))*Math.cos(toRad(lat2)) *
              Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  function habilitarFormulario(msgOk){
    elNome.disabled = false;
    elObs.disabled = false;
    btnEnviar.disabled = false;
    geoStatus.textContent = msgOk;
    geoStatus.className = 'muted ok';
  }
  function bloquearFormulario(msgErro){
    elNome.disabled = true;
    elObs.disabled = true;
    btnEnviar.disabled = true;
    geoStatus.textContent = msgErro;
    geoStatus.className = 'muted err';
  }

  async function carregarNomes(){
    try{
      // CHANGED: reaproveita o init de Faltas, que j√° l√™ a aba Cadastro
      const r = await fetch('/api/faltas/init.js');     // <<<<< CHANGED
      const j = await r.json();
      if (!j.ok) throw new Error(j.message || 'Falha ao carregar nomes');

      const nomes = j.nomes || [];
      elNome.innerHTML = '<option value="">Selecione...</option>' +
        nomes.map(n => `<option>${n}</option>`).join('');
    }catch(err){
      showMsg(false, 'Erro ao carregar nomes: ' + (err?.message || err));
    }
  }

  function solicitarLocalizacao(){
    if (!navigator.geolocation){
      bloquearFormulario('Seu dispositivo n√£o permite localiza√ß√£o.');
      return;
    }
    navigator.geolocation.getCurrentPosition(
      pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const dist = distanciaEmMetros(lat, lon, LAT_TERREIRO, LON_TERREIRO);

        if (dist <= RAIO_MAX_METROS){
          habilitarFormulario(`‚úÖ Localiza√ß√£o confirmada (~${dist.toFixed(0)}m)`);
        } else {
          bloquearFormulario('‚ùå Voc√™ est√° fora do per√≠metro do terreiro.');
        }
      },
      err => {
        console.error(err);
        bloquearFormulario('‚ùå N√£o foi poss√≠vel obter sua localiza√ß√£o.');
      },
      { enableHighAccuracy: true, timeout: 15000 }
    );
  }

  // envio simplificado: s√≥ nome + observa√ß√£o (seu endpoint atual)
  btnEnviar.addEventListener('click', async () => {
    const nome = (elNome.value || '').trim();
    const observacao = (elObs.value || '').trim();
    if (!nome) return showMsg(false, 'Selecione seu nome.');

    btnEnviar.disabled = true; btnEnviar.textContent = 'Enviando...';
    elMsg.style.display = 'none';

    try{
      // CHANGED: use o mesmo endpoint que voc√™ j√° tem para salvar presen√ßa
      const r = await fetch('/api/presencas/salvar.js', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ nome, observacao })
      });
      const j = await r.json();
      if (!j.ok) throw new Error(j.message || 'Falha ao registrar');
      showMsg(true, '‚úÖ Presen√ßa registrada com sucesso.');
      elObs.value = '';
    }catch(err){
      showMsg(false, '‚ùå ' + (err?.message || err));
    }finally{
      btnEnviar.disabled = false; btnEnviar.textContent = 'Registrar Presen√ßa';
    }
  });

  document.addEventListener('DOMContentLoaded', () => {
    // carrega nomes independente do GPS,
    // mas s√≥ habilita o formul√°rio ap√≥s a valida√ß√£o da localiza√ß√£o
    carregarNomes();
    solicitarLocalizacao();
  });
</script>

</body>
</html>
