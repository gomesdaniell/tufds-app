<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Lista de Presen√ßa ‚Äì TUFDS</title>
<style>
  body{font-family:Arial, sans-serif; background:#f8f9fb; margin:0; color:#333}
  .wrap{max-width:680px; margin:32px auto; background:#fff; padding:22px; border-radius:14px; box-shadow:0 2px 10px rgba(0,0,0,.08)}
  h1{margin:0 0 8px}
  label{font-weight:700; display:block; margin:10px 0 6px}
  select, input{width:100%; padding:10px; border:1px solid #ccc; border-radius:8px; font-size:14px; box-sizing:border-box}
  .muted{font-size:12px; color:#666}
  .row{display:flex; gap:12px; flex-wrap:wrap}
  .row>*{flex:1 1 220px}
  button{background:#111827; color:#fff; border:0; padding:10px 16px; border-radius:8px; cursor:pointer; font-weight:700}
  button:hover{background:#333}
  #msg{display:none; margin-top:12px; padding:10px; border-radius:8px; text-align:center; font-weight:700}
  #msg.ok{background:#e8f5e9; color:#256029}
  #msg.err{background:#fdecea; color:#a12721}
  #geoStatus{margin-bottom:10px}
  #geoStatus.ok{color:#15803d}
  #geoStatus.err{color:#b91c1c}
  .btn-ghost{background:#0f766e; border:0; border-radius:10px; padding:8px 12px; font-weight:700}
  .btn-ghost:hover{background:#0d5f57}
  .actions{display:flex; gap:8px; align-items:center; margin:8px 0 16px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Lista de Presen√ßa ‚Äì TUFDS</h1>

    <div id="geoStatus" class="muted">Clique em <b>Permitir localiza√ß√£o</b> para liberar o formul√°rio.</div>
    <div class="actions">
      <button id="btnGeo" class="btn-ghost">Permitir localiza√ß√£o</button>
      <button id="btnRetry" class="btn-ghost" style="display:none">Tentar novamente</button>
      <span id="geoHint" class="muted"></span>
    </div>

    <label>Seu nome</label>
    <select id="nome" disabled></select>

    <div class="row">
      <div>
        <label>Observa√ß√£o (opcional)</label>
        <input id="obs" type="text" placeholder="Atraso, justificativa, etc." disabled/>
      </div>
    </div>

    <div style="margin-top:12px">
      <button id="btnEnviar" disabled>Registrar Presen√ßa</button>
    </div>

    <div id="msg"></div>
  </div>

<script>
  // üìç Coordenadas do terreiro (mesmas do seu projeto) -3.072586021397572,-60.042981419063146
  const LAT_TERREIRO = -3.074382105349791;
  const LON_TERREIRO = -59.99540507934922;
  const RAIO_MAX_METROS = 300;

  const elNome   = document.getElementById('nome');
  const elObs    = document.getElementById('obs');
  const elMsg    = document.getElementById('msg');
  const btnEnviar= document.getElementById('btnEnviar');
  const geoStatus= document.getElementById('geoStatus');
  const btnGeo   = document.getElementById('btnGeo');
  const btnRetry = document.getElementById('btnRetry');
  const geoHint  = document.getElementById('geoHint');

  let lastLat = null, lastLon = null;
  let watchId = null;

  function showMsg(ok, text){
    elMsg.className = ok ? 'ok' : 'err';
    elMsg.textContent = text;
    elMsg.style.display = 'block';
    if (ok) setTimeout(()=> elMsg.style.display='none', 4000);
  }
  function toRad(g){ return g * Math.PI / 180; }
  function distanciaEmMetros(lat1, lon1, lat2, lon2){
    const R = 6371000;
    const dLat = toRad(lat2 - lat1), dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }
  function habilitarFormulario(msgOk){
    elNome.disabled = false;
    elObs.disabled = false;
    btnEnviar.disabled = false;
    geoStatus.textContent = msgOk;
    geoStatus.className = 'muted ok';
    btnRetry.style.display = 'none';
  }
  function bloquearFormulario(msgErro, showRetry=true){
    elNome.disabled = true;
    elObs.disabled = true;
    btnEnviar.disabled = true;
    geoStatus.textContent = msgErro;
    geoStatus.className = 'muted err';
    if (showRetry) btnRetry.style.display = 'inline-block';
  }

  // Solicita geolocaliza√ß√£o somente ap√≥s gesto do usu√°rio
  async function requestLocation(){
    btnGeo.disabled = true;
    btnRetry.style.display = 'none';
    geoHint.textContent = '';

    if (!('geolocation' in navigator)){
      bloquearFormulario('Seu dispositivo n√£o oferece geolocaliza√ß√£o.');
      btnGeo.disabled = false;
      return;
    }

    // Tentativa 1: getCurrentPosition com alta precis√£o
    let settled = false;
    const opts = { enableHighAccuracy:true, timeout:12000, maximumAge: 15000 };

    const onSuccess = (pos) => {
      if (settled) return; settled = true;
      if (watchId) navigator.geolocation.clearWatch(watchId);
      const lat = pos.coords.latitude, lon = pos.coords.longitude;
      lastLat = lat; lastLon = lon;
      const dist = distanciaEmMetros(lat, lon, LAT_TERREIRO, LON_TERREIRO);
      if (dist <= RAIO_MAX_METROS){
        habilitarFormulario(`‚úÖ Localiza√ß√£o confirmada. Dist√¢ncia aproximada: ${dist.toFixed(0)}m do terreiro.`);
      } else {
        bloquearFormulario('‚ùå Voc√™ est√° distante do terreiro. A presen√ßa s√≥ pode ser registrada no local.');
      }
      btnGeo.disabled = false;
    };

    const onError = (err) => {
      if (settled) return;
      console.warn('getCurrentPosition erro:', err);
      // Se negar permiss√£o, mostra instru√ß√£o
      if (err && err.code === 1){ // PERMISSION_DENIED
        bloquearFormulario('Permiss√£o negada. Ative a localiza√ß√£o do navegador e volte.', false);
        geoHint.textContent = 'No Android/Chrome: Cadeado ‚Üí Permiss√µes ‚Üí Localiza√ß√£o ‚Üí Permitir.';
        btnGeo.disabled = false;
        return;
      }
      // Fallback 2: watchPosition (muitos aparelhos entregam mais r√°pido)
      geoHint.textContent = 'Tentando localiza√ß√£o alternativa‚Ä¶';
      watchId = navigator.geolocation.watchPosition(onSuccess, (e2)=>{
        console.warn('watchPosition erro:', e2);
        bloquearFormulario('N√£o foi poss√≠vel obter sua localiza√ß√£o. Ative o GPS e tente novamente.');
        btnGeo.disabled = false;
      }, { enableHighAccuracy:true, maximumAge: 0, timeout: 20000 });
      // Cancela o watch ap√≥s 20s para n√£o ficar eterno
      setTimeout(()=>{
        if (!settled && watchId){
          navigator.geolocation.clearWatch(watchId);
          bloquearFormulario('Tempo esgotado para obter localiza√ß√£o. Tente novamente.');
          btnGeo.disabled = false;
        }
      }, 20000);
    };

    navigator.geolocation.getCurrentPosition(onSuccess, onError, opts);
  }

  // Carrega nomes (ativos) do backend
  async function carregarNomes(){
    try{
      const res = await fetch('/api/presencas/init.js');
      const j = await res.json();
      if (!j.ok) throw new Error(j.message || 'Falha ao carregar nomes.');
      elNome.innerHTML = '<option value="">Selecione...</option>' + (j.nomes||[]).map(n=>`<option>${n}</option>`).join('');
    }catch(e){
      showMsg(false, 'Erro ao carregar nomes: ' + e.message);
    }
  }

  // Envia presen√ßa
  document.getElementById('btnEnviar').addEventListener('click', async ()=>{
    const nome = (elNome.value || '').trim();
    const observacao = (elObs.value || '').trim();
    if (!nome) return showMsg(false, 'Selecione o seu nome.');

    btnEnviar.disabled = true; btnEnviar.textContent = 'Enviando...';
    elMsg.style.display = 'none';

    try{
      const res = await fetch('/api/presencas/salvar.js', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ nome, observacao, lat:lastLat, lon:lastLon })
      });
      const data = await res.json();
      if (!res.ok || !data.ok) throw new Error(data?.message || 'Falha ao salvar.');

      btnEnviar.disabled = false; btnEnviar.textContent = 'Registrar Presen√ßa';
      showMsg(true, '‚úÖ Presen√ßa registrada com sucesso.');
      elObs.value = '';
    }catch(e){
      btnEnviar.disabled = false; btnEnviar.textContent = 'Registrar Presen√ßa';
      showMsg(false, '‚ùå ' + e.message);
    }
  });

  // Bot√µes de controle
  btnGeo.addEventListener('click', requestLocation);
  btnRetry.addEventListener('click', requestLocation);

  // Inicializa√ß√£o
  document.addEventListener('DOMContentLoaded', ()=>{
    // dica se n√£o estiver em contexto seguro (HTTP bloqueia geolocaliza√ß√£o)
    if (location.protocol !== 'https:'){
      geoHint.textContent = 'Observa√ß√£o: geolocaliza√ß√£o pode n√£o funcionar fora de HTTPS.';
    }
    carregarNomes();
  });
</script>
</body>
</html>
