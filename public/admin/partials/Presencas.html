<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Lista de Presença – TUFDS</title>
<style>
  body{font-family:Arial,sans-serif;background:#f8f9fb;margin:0;color:#333}
  .wrap{max-width:680px;margin:32px auto;background:#fff;padding:22px;border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
  h1{margin:0 0 8px}
  label{font-weight:700;display:block;margin:10px 0 6px}
  select,input,textarea{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;font-size:14px;box-sizing:border-box}
  .muted{font-size:12px;color:#666}
  button{background:#111827;color:#fff;border:0;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:700}
  button:hover{background:#333}
  #msg{display:none;margin-top:12px;padding:10px;border-radius:8px;text-align:center;font-weight:700}
  #msg.ok{background:#e8f5e9;color:#256029}
  #msg.err{background:#fdecea;color:#a12721}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Lista de Presença – TUFDS</h1>
    <div class="muted">Preencha seu nome. (Somente lista os ativos da aba Cadastro.)</div>

    <label>Seu nome</label>
    <select id="nome">
      <option value="">Carregando nomes...</option>
    </select>

    <label>Observação (opcional)</label>
    <input id="obs" type="text" placeholder="Atraso, justificativa, etc."/>

    <div style="margin-top:12px">
      <button id="btnEnviar" type="button">Registrar Presença (placeholder)</button>
    </div>

    <div id="msg"></div>
  </div>

<script>
  const elNome = document.getElementById('nome');
  const elMsg  = document.getElementById('msg');

  function showMsg(ok, text){
    elMsg.className = ok ? 'ok' : 'err';
    elMsg.textContent = text;
    elMsg.style.display = 'block';
    if (ok) setTimeout(()=> elMsg.style.display='none', 4000);
  }

  async function carregarNomes(){
    try{
      const r = await fetch('/api/presencas/init.js', { cache: 'no-store' });
      const raw = await r.text();                      // <= lê como texto
      let j;
      try { j = JSON.parse(raw); }                    // <= tenta parsear
      catch (e) {
        console.error('Resposta não-JSON da API:', raw);
        throw new Error('A API não retornou JSON. Veja o console para detalhes.');
      }

      if (!j.ok) throw new Error(j.message || 'Falha ao carregar nomes.');
      const nomes = j.nomes || [];
      elNome.innerHTML =
        '<option value="">Selecione...</option>' +
        nomes.map(n => `<option>${n}</option>`).join('');

      if (!nomes.length) showMsg(false, 'Nenhum nome ativo encontrado na aba Cadastro.');
    }catch(err){
      elNome.innerHTML = '<option value="">Erro ao carregar nomes</option>';
      showMsg(false, 'Erro ao carregar: ' + (err?.message || err));
    }
  }

  document.addEventListener('DOMContentLoaded', carregarNomes);

  document.getElementById('btnEnviar').addEventListener('click', () => {
    const nome = (elNome.value || '').trim();
    if (!nome) return showMsg(false, 'Selecione seu nome.');
    showMsg(true, `Presença registrada (demo) para: ${nome}`);
  });
</script>

</body>
</html>
